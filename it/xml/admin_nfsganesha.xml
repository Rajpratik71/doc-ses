<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="admin_nfsganesha.xml" version="5.0" xml:id="cha-ceph-nfsganesha">

 <title>NFS Ganesha: esportazione dei dati Ceph tramite NFS</title>
 <info>
      <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
        <dm:maintainer>tbazant@suse.com</dm:maintainer>
        <dm:status>modifica</dm:status>
        <dm:deadline/>
        <dm:priority/>
        <dm:translation>sì</dm:translation>
        <dm:languages/>
        <dm:release>SES 5</dm:release>
      </dm:docmanager>
    </info>
    
 <para>
  NFS Ganesha è un server NFS (fare riferimento a <link xlink:href="https://www.suse.com/documentation/sles-12/book_sle_admin/data/cha_nfs.html">Sharing File Systems with NFS</link>, in lingua inglese) che viene eseguito in uno spazio di indirizzo dell'utente come parte del kernel del sistema operativo. Con NFS Ganesha, è possibile collegare un meccanismo di memorizzazione, come Ceph, e accedervi da qualsiasi client NFS.
 </para>
 <para>
  I compartimenti S3 vengono esportati in NFS in base a ogni singolo utente, ad esempio tramite il percorso <filename><replaceable>GANESHA_NODE:</replaceable>/<replaceable>USERNAME</replaceable>/<replaceable>BUCKETNAME</replaceable></filename>.
 </para>
 <para>
  Un CephFS viene esportato per default tramite il percorso <filename><replaceable>GANESHA_NODE:</replaceable>/cephfs</filename>.
 </para>
 <sect1 xml:id="ceph-nfsganesha-install">
  <title>Installazione</title>

  <para>
   Per istruzioni sull'installazione, vedere <xref linkend="cha-as-ganesha"/>.
  </para>
 </sect1>
 <sect1 xml:id="ceph-nfsganesha-config">
  <title>Configurazione</title>

  <para>
   Per un elenco di tutti i parametri disponibili nel file di configurazione, vedere:
  </para>

  <itemizedlist>
   <listitem>
    <para>
     <command>man ganesha-config</command>
    </para>
   </listitem>
   <listitem>
    <para>
     <command>man ganesha-ceph-config</command> per le opzioni dello strato di astrazione del file system (FSAL, File System Abstraction Layer) CephFS.
    </para>
   </listitem>
   <listitem>
    <para>
     <command>man ganesha-rgw-config</command> per le opzioni FSAL Object Gateway.
    </para>
   </listitem>
  </itemizedlist>

  <para>
   In questa sezione sono incluse informazioni utili per configurare il server NFS Ganesha in modo che i dati del cluster siano accessibili tramite Object Gateway e CephFS.
  </para>

  <para>
   La configurazione di NFS Ganesha viene controllata da <filename>/etc/ganesha/ganesha.conf</filename>. Le modifiche al file vengono sovrascritte quando si esegue la fase 4 DeepSea. Per modificare le impostazioni in modo permanente, modificare il file <filename>/srv/salt/ceph/ganesha/files/ganesha.conf.j2</filename> ubicato nel Salt master.
  </para>

  <sect2 xml:id="ceph-nfsganesha-config-general">
   <title>Sezione di esportazione</title>
   <para>
    In questa sezione è descritto come configurare le sezioni <literal>EXPORT</literal> in <filename>ganesha.conf</filename>.
   </para>
<screen>EXPORT
{
  Export_Id = 1;
  Path = "/";
  Pseudo = "/";
  Access_Type = RW;
  Squash = No_Root_Squash;
  [...]
  FSAL {
    Name = CEPH;
  }
}</screen>
   <sect3 xml:id="ceph-nfsganesha-config-general-export">
    <title>Sezione di esportazione principale</title>
    <variablelist>
     <varlistentry>
      <term>Export_Id</term>
      <listitem>
       <para>
        Ciascuna esportazione deve disporre di un "Export_Id" (Id di esportazione) (obbligatorio).
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>Path</term>
      <listitem>
       <para>
        Percorso di esportazione nel pool CephFS correlato (obbligatorio). Consente di esportare le sottodirectory da CephFS.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>Pseudo</term>
      <listitem>
       <para>
        Percorso di esportazione NFS di destinazione (obbligatorio per NFSv4). Definisce sotto quale percorso di esportazione NFS sono disponibili i dati esportati.
       </para>
       <para>
        Esempio: con il valore <literal>/cephfs/</literal> e dopo aver eseguito
       </para>
<screen>
<prompt>root # </prompt>mount <replaceable>GANESHA_IP</replaceable>:/cephfs/ /mnt/
</screen>
       <para>
        I dati CephFS sono disponibili nella directory <filename>/mnt/cephfs/</filename> sul client.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>Access_Type</term>
      <listitem>
       <para>
        "RO" per accesso in sola lettura, l'impostazione di default è "None".
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>Squash</term>
      <listitem>
       <para>
        Opzione squash NFS.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>FSAL</term>
      <listitem>
       <para>
        Esportazione dello strato di astrazione del file system (FSAL, File System Abstraction Layer). Vedere <xref linkend="ceph-nfsganesha-config-general-fsal"/>.
       </para>
      </listitem>
     </varlistentry>
    </variablelist>
   </sect3>
   <sect3 xml:id="ceph-nfsganesha-config-general-fsal">
    <title>Sottosezione FSAL</title>
<screen>EXPORT
{
  [...]
  FSAL {
    Name = CEPH;
  }
}</screen>
    <variablelist>
     <varlistentry>
      <term>Name</term>
      <listitem>
       <para>
        Definisce il back end utilizzato da NFS Ganesha. I valori consentiti sono <literal>CEPH</literal> per CephFS o <literal>RGW</literal> per Object Gateway. A seconda della scelta, è necessario definire <literal>role-mds</literal> o <literal>role-rgw</literal> in <filename>policy.cfg</filename>.
       </para>
      </listitem>
     </varlistentry>
    </variablelist>
   </sect3>
  </sect2>

  <sect2 xml:id="ceph-nfsganesha-config-rgw">
   <title>Sezione RGW</title>
<screen>RGW {
  ceph_conf = "/etc/ceph/ceph.conf";
  name = "name";
  cluster = "ceph";
}</screen>
   <variablelist>
    <varlistentry>
     <term>ceph_conf</term>
     <listitem>
      <para>
       Punta al file <filename>ceph.conf</filename>. Quando si esegue la distribuzione con DeepSea, non è necessario modificare questo valore.
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>name</term>
     <listitem>
      <para>
       Nome dell'utente client Ceph utilizzato da NFS Ganesha.
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>cluster</term>
     <listitem>
      <para>
       Nome del cluster Ceph. Attualmente SUSE Enterprise Storage 5 supporta solo un nome cluster, che per default è <literal>ceph</literal>.
      </para>
     </listitem>
    </varlistentry>
   </variablelist>
  </sect2>

  <sect2 xml:id="ganesha-nfsport">
   <title>Modifica delle porte NFS Ganesha di default</title>
   <para>
    Per default, NFS Ganesha utilizza la porta 2049 per NFS e la 875 per il supporto rquota. Per modificare i numeri di porta di default, utilizzare le opzioni <option>NFS_Port</option> e <option>RQUOTA_Port</option> incluse nella sezione <literal>NFS_CORE_PARAM</literal>, ad esempio:
   </para>
<screen>
NFS_CORE_PARAM
{
 NFS_Port = 2060;
 RQUOTA_Port = 876;
}
</screen>
  </sect2>
 </sect1>
 <sect1 xml:id="ceph-nfsganesha-customrole">
  <title>Ruoli NFS Ganesha personalizzati</title>

  <para>
   È possibile definire ruoli NFS Ganesha personalizzati per i nodi del cluster. Tali ruoli vengono quindi assegnati ai ruoli in <filename>policy.cfg</filename>. I ruoli consentono:
  </para>

  <itemizedlist>
   <listitem>
    <para>
     a nodi NFS Ganesha separati di accedere a Object Gateway e CephFS.
    </para>
   </listitem>
   <listitem>
    <para>
     di assegnare diversi utenti Object Gateway ai nodi NFS Ganesha.
    </para>
   </listitem>
  </itemizedlist>

  <para>
   Il fatto di disporre di diversi utenti Object Gateway consente ai nodi NFS Ganesha di accedere a diversi compartimenti S3. È possibile utilizzare i compartimenti S3 per il controllo dell'accesso. Nota: non confondere i compartimenti S3 con i compartimenti Ceph utilizzati nella mappa CRUSH.
  </para>

  <sect2 xml:id="ceph-nfsganesha-customrole-rgw-multiusers">
   <title>Utenti Object Gateway diversi per NFS Ganesha</title>
   <para>
    Nella seguente procedura di esempio per Salt master è illustrato come creare due ruoli NFS Ganesha con diversi utenti Object Gateway. In questo esempio, vengono utilizzati i ruoli <literal>gold</literal> e <literal>silver</literal>, per i quali DeepSea fornisce già i file di configurazione di esempio.
   </para>
   <procedure xml:id="proc-ceph-nfsganesha-rgw-multiusers">
    <step>
     <para>
      Aprire il file <filename>/srv/pillar/ceph/stack/global.yml</filename> con un editor a scelta. Creare il file qualora non esistesse.
     </para>
    </step>
    <step>
     <para>
      Il file deve contenere le righe seguenti:
     </para>
<screen>rgw_configurations:
  - rgw
  - silver
  - gold
ganesha_configurations:
  - silver
  - gold</screen>
     <para>
      Successivamente, è possibile assegnare questi ruoli nel file <filename>policy.cfg</filename>.
     </para>
    </step>
    <step>
     <para>
      Creare un file <filename>/srv/salt/ceph/rgw/users/users.d/gold.yml</filename> e aggiungere il contenuto seguente:
     </para>
<screen>- { uid: "gold1", name: "gold1", email: "gold1@demo.nil" }</screen>
     <para>
      Creare un file <filename>/srv/salt/ceph/rgw/users/users.d/silver.yml</filename> e aggiungere il contenuto seguente:
     </para>
<screen>- { uid: "silver1", name: "silver1", email: "silver1@demo.nil" }</screen>
    </step>
    <step>
     <para>
      Adesso, per ogni ruolo è necessario creare i modelli per il file <filename>ganesha.conf</filename>. Il modello originale di DeepSea è un buon inizio. Creare due copie:
     </para>
<screen><prompt>root # </prompt><command>cd</command> /srv/salt/ceph/ganesha/files/
<prompt>root # </prompt><command>cp</command> ganesha.conf.j2 silver.conf.j2
<prompt>root # </prompt><command>cp</command> ganesha.conf.j2 gold.conf.j2</screen>
    </step>
    <step>
     <para>
      Sono richiesti i portachiavi per i nuovi ruoli affinché questi accedano al cluster. Per fornire l'accesso, copiare <filename>ganesha.j2</filename>:
     </para>
<screen><prompt>root # </prompt><command>cp</command> ganesha.j2 silver.j2
<prompt>root # </prompt><command>cp</command> ganesha.j2 gold.j2</screen>
    </step>
    <step>
     <para>
      Copiare il portachiavi per Object Gateway:
     </para>
<screen><prompt>root # </prompt><command>cd</command> /srv/salt/ceph/rgw/files/
<prompt>root # </prompt><command>cp</command> rgw.j2 silver.j2
<prompt>root # </prompt><command>cp</command> rgw.j2 gold.j2</screen>
    </step>
    <step>
     <para>
      In Object Gateway è inoltre necessaria la configurazione per i ruoli diversi:
     </para>
<screen><prompt>root # </prompt><command>cd</command> /srv/salt/ceph/configuration/files/
<prompt>root # </prompt><command>cp</command> ceph.conf.rgw silver.conf
<prompt>root # </prompt><command>cp</command> ceph.conf.rgw gold.conf</screen>
    </step>
    <step>
     <para>
      Assegnare i ruoli appena creati ai nodi del cluster in <filename>/srv/pillar/ceph/proposals/policy.cfg</filename>:
     </para>
<screen>role-silver/cluster/<replaceable>NODE1</replaceable>.sls
role-gold/cluster/<replaceable>NODE2</replaceable>.sls
 </screen>
     <para>
      Sostituire<replaceable>NODE1</replaceable> e <replaceable>NODE2</replaceable> con i nomi dei nodi cui si desidera assegnare i ruoli.
     </para>
    </step>
    <step>
     <para>
      Eseguire le fasi da 0 a 4 di DeepSea.
     </para>
    </step>
   </procedure>
  </sect2>

  <sect2 xml:id="ceph-nfsganesha-customrole-rgw-cephfs">
   <title>Separazione di FSAL CephFS e Object Gateway</title>
   <para>
    Nella seguente procedura di esempio per Salt master è illustrato come creare due nuovi ruoli diversi che utilizzano CephFS e Object Gateway:
   </para>
   <procedure xml:id="proc-ceph-nfsganesha-customrole">
    <step>
     <para>
      Aprire il file <filename>/srv/pillar/ceph/rgw.sls</filename> con un editor a scelta. Creare il file qualora non esistesse.
     </para>
    </step>
    <step>
     <para>
      Il file deve contenere le righe seguenti:
     </para>
<screen>rgw_configurations:
  ganesha_cfs:
    users:
      - { uid: "demo", name: "Demo", email: "demo@demo.nil" }
  ganesha_rgw:
    users:
      - { uid: "demo", name: "Demo", email: "demo@demo.nil" }

ganesha_configurations:
  - ganesha_cfs
  - ganesha_rgw</screen>
     <para>
      Successivamente, è possibile assegnare questi ruoli nel file <filename>policy.cfg</filename>.
     </para>
    </step>
    <step>
     <para>
      Adesso, per ogni ruolo è necessario creare i modelli per il file <filename>ganesha.conf</filename>. Il modello originale di DeepSea è un buon inizio. Creare due copie:
     </para>
<screen><prompt>root # </prompt><command>cd</command> /srv/salt/ceph/ganesha/files/
<prompt>root # </prompt><command>cp</command> ganesha.conf.j2 ganesha_rgw.conf.j2
<prompt>root # </prompt><command>cp</command> ganesha.conf.j2 ganesha_cfs.conf.j2</screen>
    </step>
    <step>
     <para>
      Modificare <filename>ganesha_rgw.conf.j2</filename> e rimuovere la sezione:
     </para>
<screen>{% if salt.saltutil.runner('select.minions', cluster='ceph', roles='mds') != [] %}
        [...]
{% endif %}</screen>
    </step>
    <step>
     <para>
      Modificare <filename>ganesha_cfs.conf.j2</filename> e rimuovere la sezione:
     </para>
<screen>{% if salt.saltutil.runner('select.minions', cluster='ceph', roles=role) != [] %}
        [...]
{% endif %}</screen>
    </step>
    <step>
     <para>
      Sono richiesti i portachiavi per i nuovi ruoli affinché questi accedano al cluster. Per fornire l'accesso, copiare <filename>ganesha.j2</filename>:
     </para>
<screen><prompt>root # </prompt><command>cp</command> ganesha.j2 ganesha_rgw.j2
<prompt>root # </prompt><command>cp</command> ganesha.j2 ganesha_cfs.j2</screen>
     <para>
      È possibile rimuovere la riga <literal>caps mds = "allow *"</literal> da <filename>ganesha_rgw.j2</filename>.
     </para>
    </step>
    <step>
     <para>
      Copiare il portachiavi per Object Gateway:
     </para>
<screen><prompt>root # </prompt><command>cp</command> /srv/salt/ceph/rgw/files/rgw.j2 \
/srv/salt/ceph/rgw/files/ganesha_rgw.j2</screen>
    </step>
    <step>
     <para>
      Per Object Gateway è necessaria la configurazione del nuovo ruolo:
     </para>
<screen><prompt>root # </prompt><command>cp</command> /srv/salt/ceph/configuration/files/ceph.conf.rgw \
/srv/salt/ceph/configuration/files/ceph.conf.ganesha_rgw</screen>
    </step>
    <step>
     <para>
      Assegnare i ruoli appena creati ai nodi del cluster in <filename>/srv/pillar/ceph/proposals/policy.cfg</filename>:
     </para>
<screen>role-ganesha_rgw/cluster/<replaceable>NODE1</replaceable>.sls
role-ganesha_cfs/cluster/<replaceable>NODE1</replaceable>.sls
 </screen>
     <para>
      Sostituire<replaceable>NODE1</replaceable> e <replaceable>NODE2</replaceable> con i nomi dei nodi cui si desidera assegnare i ruoli.
     </para>
    </step>
    <step>
     <para>
      Eseguire le fasi da 0 a 4 di DeepSea.
     </para>
    </step>
   </procedure>
  </sect2>
 </sect1>
 <sect1 xml:id="ceph-nfsganesha-services">
  <title>Avvio o riavvio di NFS Ganesha</title>

  <para>
   Per abilitare e avviare il servizio NFS Ganesha, eseguire:
  </para>

<screen><prompt>root # </prompt><command>systemctl</command> enable nfs-ganesha
<prompt>root # </prompt><command>systemctl</command> start nfs-ganesha</screen>

  <para>
   Riavviare NFS Ganesha con:
  </para>

<screen><prompt>root # </prompt><command>systemctl</command> restart nfs-ganesha</screen>

  <para>
   Quando si avvia o riavvia NFS Ganesha, il timeout di tolleranza per NFS v4 è di 90 secondi. Durante la moratoria, le nuove richieste dai client vengono rifiutate attivamente. Pertanto, è possibile che i client subiscano un rallentamento delle richieste durante lo stato di moratoria di NFS.
  </para>
 </sect1>
 <sect1 xml:id="ceph-nfsganesha-loglevel">
  <title>Impostazione del livello di log</title>

  <para>
   È possibile modificare il livello di debug di default <literal>NIV_EVENT</literal> modificando il file <filename>/etc/sysconfig/nfs-ganesha</filename>. Sostituire <literal>NIV_EVENT</literal> con <literal>NIV_DEBUG</literal> o <literal>NIV_FULL_DEBUG</literal>. L'aumento del livello di dettaglio del log può produrre grandi quantità di dati nei file di log.
  </para>

<screen>OPTIONS="-L /var/log/ganesha/ganesha.log -f /etc/ganesha/ganesha.conf -N NIV_EVENT"</screen>

  <para>
   Quando si modifica il livello di log è necessario riavviare il servizio.
  </para>
 </sect1>
 <sect1 xml:id="ceph-nfsganesha-verify">
  <title>Verifica della condivisione NFS esportata</title>

  <para>
   Quando si utilizza NFS v3, è possibile verificare se le condivisioni NFS vengono esportate nel nodo server di NFS Ganesha:
  </para>

<screen><prompt>root # </prompt><command>showmount</command> -e
/ (everything)</screen>
 </sect1>
 <sect1 xml:id="ceph-nfsganesha-mount">
  <title>Montaggio della condivisione NFS esportata</title>

  <para>
   Per montare la condivisione NFS esportata (come configurato nella <xref linkend="ceph-nfsganesha-config"/>) su un host client, eseguire:
  </para>

<screen><prompt>root # </prompt><command>mount</command> -t nfs -o rw,noatime,sync \
 <replaceable>nfs_ganesha_server_hostname:/ /path/to/local/mountpoint</replaceable></screen>
 </sect1>
 <sect1 xml:id="ceph-nfsganesha-more">
  <title>Risorse aggiuntive</title>

  <para>
   La documentazione originale su NFS Ganesha è disponibile al sito <link xlink:href="https://github.com/nfs-ganesha/nfs-ganesha/wiki/Docs"/> (in lingua inglese).
  </para>
 </sect1>
</chapter>
