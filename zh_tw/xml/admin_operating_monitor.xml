<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="admin_operating_monitor.xml" version="5.0" xml:id="ceph-monitor">
 <title>確定叢集狀態</title>
 <info>
      <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
        <dm:translation>yes</dm:translation>
        <dm:release>SES 5</dm:release>
      </dm:docmanager>
    </info>
    <para>
  當叢集正在執行時，您可以使用 <command>ceph</command> 工具來監控叢集。確定叢集狀態一般涉及檢查 OSD、監控程式、放置群組和中繼資料伺服器的狀態。<remark role="fixme">Maybe revert to old version of sentence: Determining the cluster state typically involves
  checking OSD status, monitor status, placement group status and metadata
  server status.</remark>
 </para>
 <tip>
  <title>互動模式</title>
  <para>
   若要以互動模式執行 <command>ceph</command> 工具，請不帶任何引數在指令行中輸入 <command>ceph</command>。如果要在一行中輸入多條 <command>ceph</command> 指令，則使用互動模式較為方便。例如︰
  </para>
<screen><prompt>cephadm &gt; </prompt>ceph
ceph&gt; health
ceph&gt; status
ceph&gt; quorum_status
ceph&gt; mon_status</screen>
 </tip>
 <sect1 xml:id="monitor-health">
  <title>檢查叢集狀態</title>

  <para>
   在啟動叢集後到開始讀取和/或寫入資料期間，檢查叢集的狀態︰
  </para>

<screen><prompt>root # </prompt>ceph health
HEALTH_WARN 10 pgs degraded; 100 pgs stuck unclean; 1 mons down, quorum 0,2 \
node-1,node-2,node-3</screen>

  <para>
   Ceph 叢集會傳回下列狀態代碼之一︰
  </para>

  <variablelist>
   <varlistentry>
    <term>OSD_DOWN</term>
    <listitem>
     <para>
      一或多個 OSD 標示為已停機。OSD 精靈可能已停止，或對等 OSD 可能無法透過網路連接 OSD。常見原因包括精靈已停止或已當機、主機已停機或網路中斷。
     </para>
     <para>
      驗證主機是否執行良好，精靈是否已啟動，並且網路是否正常運作。如果精靈已當機，精靈記錄檔案 (<filename>/var/log/ceph/ceph-osd.*</filename>) 可能會包含除錯資訊。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>OSD_<replaceable>crush type</replaceable>_DOWN，例如 OSD_HOST_DOWN</term>
    <listitem>
     <para>
      特定 CRUSH 子樹中的所有 OSD (例如主機上的所有 OSD) 均標示為已停機。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>OSD_ORPHAN</term>
    <listitem>
     <para>
      在 CRUSH 地圖階層中參考了 OSD，但它不存在。可使用以下指令從 CRUSH 階層中移除 OSD︰
     </para>
<screen><prompt>root # </prompt>ceph osd crush rm osd.<replaceable>ID</replaceable></screen>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>OSD_OUT_OF_ORDER_FULL</term>
    <listitem>
     <para>
      <emphasis>backfillfull</emphasis>、<emphasis>nearfull</emphasis>、<emphasis>full</emphasis> 和/或 <emphasis>failsafe_full</emphasis> 的使用量閾值沒有採用升序。特別是，我們需要 <emphasis>backfillfull</emphasis> &lt; <emphasis>nearfull</emphasis>，<emphasis>nearfull</emphasis> &lt; <emphasis>full</emphasis> 且 <emphasis>full</emphasis> &lt; <emphasis>failsafe_full</emphasis>。可使用以下指令調整閾值︰
     </para>
<screen><prompt>root # </prompt>ceph osd set-backfillfull-ratio <replaceable>ratio</replaceable>
<prompt>root # </prompt>ceph osd set-nearfull-ratio <replaceable>ratio</replaceable>
<prompt>root # </prompt>ceph osd set-full-ratio <replaceable>ratio</replaceable></screen>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>OSD_FULL</term>
    <listitem>
     <para>
      一或多個 OSD 超出了 <emphasis>full</emphasis> 閾值，阻止叢集處理寫入操作。可使用以下指令檢查各池的使用量︰
     </para>
<screen><prompt>root # </prompt>ceph df</screen>
     <para>
      可使用以下指令查看目前定義的 <emphasis>full</emphasis> 比率︰
     </para>
<screen><prompt>root # </prompt>ceph osd dump | grep full_ratio</screen>
     <para>
      還原寫入可用性的臨時解決辦法是稍稍提高 full 閾值︰
     </para>
<screen><prompt>root # </prompt>ceph osd set-full-ratio <replaceable>ratio</replaceable></screen>
     <para>
      請透過部署更多 OSD 將新的儲存新增至叢集，或者刪除現有資料來騰出空間。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>OSD_BACKFILLFULL</term>
    <listitem>
     <para>
      一或多個 OSD 超出了 <emphasis>backfillfull</emphasis> 閾值，因而不允許將資料重新平衡到此裝置。這是一則預警，表示重新平衡可能無法完成，並且叢集將滿。可使用以下指令檢查各池的使用量︰
     </para>
<screen><prompt>root # </prompt>ceph df</screen>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>OSD_NEARFULL</term>
    <listitem>
     <para>
      一或多個 OSD 超出了 <emphasis>nearfull</emphasis> 閾值。這是一則預警，表示叢集將滿。可使用以下指令檢查各池的使用量︰
     </para>
<screen><prompt>root # </prompt>ceph df</screen>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>OSDMAP_FLAGS</term>
    <listitem>
     <para>
      已設定一或多個所需的叢集旗標。可使用以下指令設定或清除這些旗標 (<emphasis>full</emphasis> 除外)︰
     </para>
<screen><prompt>root # </prompt>ceph osd set <replaceable>flag</replaceable>
<prompt>root # </prompt>ceph osd unset <replaceable>flag</replaceable></screen>
     <para>
      這些旗標包括︰
     </para>
     <variablelist>
      <varlistentry>
       <term>full</term>
       <listitem>
        <para>
         叢集標記為已滿，無法處理寫入操作。
        </para>
       </listitem>
      </varlistentry>
      <varlistentry>
       <term>pauserd、pausewr </term>
       <listitem>
        <para>
         已暫停讀取或寫入。
        </para>
       </listitem>
      </varlistentry>
      <varlistentry>
       <term>noup</term>
       <listitem>
        <para>
         不允許 OSD 啟動。
        </para>
       </listitem>
      </varlistentry>
      <varlistentry>
       <term>nodown</term>
       <listitem>
        <para>
         將會忽略 OSD 故障報告，如此監控程式便不會將 OSD 標示為 <emphasis>down</emphasis>。
        </para>
       </listitem>
      </varlistentry>
      <varlistentry>
       <term>noin</term>
       <listitem>
        <para>
         先前標示為 <emphasis>out</emphasis> 的 OSD 在啟動時將不會重新標示為 <emphasis>in</emphasis>。
        </para>
       </listitem>
      </varlistentry>
      <varlistentry>
       <term>noout</term>
       <listitem>
        <para>
         <emphasis>停機</emphasis>的 OSD 在設定間隔過後將不會自動標示為 <emphasis>out</emphasis>。
        </para>
       </listitem>
      </varlistentry>
      <varlistentry>
       <term>nobackfill、norecover、norebalance</term>
       <listitem>
        <para>
         復原或資料重新平衡程序已暫停。
        </para>
       </listitem>
      </varlistentry>
      <varlistentry>
       <term>noscrub、nodeep_scrub</term>
       <listitem>
        <para>
         整理程序已停用 (請參閱<xref linkend="scrubbing"/>)。
        </para>
       </listitem>
      </varlistentry>
      <varlistentry>
       <term>notieragent</term>
       <listitem>
        <para>
         快取分層活動已暫停。
        </para>
       </listitem>
      </varlistentry>
     </variablelist>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>OSD_FLAGS</term>
    <listitem>
     <para>
      一或多個 OSD 設定了所需的每 OSD 旗標。這些旗標包括︰
     </para>
     <variablelist>
      <varlistentry>
       <term>noup</term>
       <listitem>
        <para>
         不允許 OSD 啟動。
        </para>
       </listitem>
      </varlistentry>
      <varlistentry>
       <term>nodown</term>
       <listitem>
        <para>
         將會忽略此 OSD 的故障報告。
        </para>
       </listitem>
      </varlistentry>
      <varlistentry>
       <term>noin</term>
       <listitem>
        <para>
         如果此 OSD 先前在發生故障後自動標示為 <emphasis>out</emphasis>，當它啟動時將不會標示為 <emphasis>in</emphasis>。
        </para>
       </listitem>
      </varlistentry>
      <varlistentry>
       <term>noout</term>
       <listitem>
        <para>
         如果此 OSD 已停機，則在設定的間隔過後，它將不會自動標示為 <emphasis>out</emphasis>。
        </para>
       </listitem>
      </varlistentry>
     </variablelist>
     <para>
      可使用以下指令來設定和清除每 OSD 旗標︰
     </para>
<screen><prompt>root # </prompt>ceph osd add-<replaceable>flag</replaceable> <replaceable>osd-ID</replaceable>
<prompt>root # </prompt>ceph osd rm-<replaceable>flag</replaceable> <replaceable>osd-ID</replaceable></screen>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>OLD_CRUSH_TUNABLES</term>
    <listitem>
     <para>
      CRUSH 地圖目前使用的設定很舊，應予以更新。<option>mon_crush_min_required_version</option> 組態選項可確定使用時不會觸發此狀態警告的最舊可調參數 (即能夠連接到叢集的最舊用戶端版本)。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>OLD_CRUSH_STRAW_CALC_VERSION</term>
    <listitem>
     <para>
      CRUSH 地圖目前使用較舊的非最佳方法來計算 straw 桶的中間權數值。應該更新 CRUSH 地圖，以使用較新的方法 (<option>straw_calc_version</option>=1)。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>CACHE_POOL_NO_HIT_SET</term>
    <listitem>
     <para>
      一或多個快取池未設定命中集來追蹤使用量，這使分層代理程式無法識別要從快取中衝洗和逐出的冷物件。可使用以下指令對快取池設定命中集︰
     </para>
<screen><prompt>root # </prompt>ceph osd pool set <replaceable>poolname</replaceable> hit_set_type <replaceable>type</replaceable>
<prompt>root # </prompt>ceph osd pool set <replaceable>poolname</replaceable> hit_set_period <replaceable>period-in-seconds</replaceable>
<prompt>root # </prompt>ceph osd pool set <replaceable>poolname</replaceable> hit_set_count <replaceable>number-of-hitsets</replaceable>
<prompt>root # </prompt>ceph osd pool set <replaceable>poolname</replaceable> hit_set_fpp <replaceable>target-false-positive-rate</replaceable></screen>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>OSD_NO_SORTBITWISE</term>
    <listitem>
     <para>
      未在執行 Luminous 12 以下版本的 OSD，但是尚未設定 <option>sortbitwise</option> 旗標。您需要先設定 <option>sortbitwise</option> 旗標，Luminous 12 或更新版本的 OSD 才能啟動︰
     </para>
<screen><prompt>root # </prompt>ceph osd set sortbitwise</screen>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>POOL_FULL</term>
    <listitem>
     <para>
      一或多個池已達到其定額，不再允許寫入。您可使用以下指令來設定池定額和使用量︰
     </para>
<screen><prompt>root # </prompt>ceph df detail</screen>
     <para>
      您可以使用以下指令來提高池定額
     </para>
<screen><prompt>root # </prompt>ceph osd pool set-quota <replaceable>poolname</replaceable> max_objects <replaceable>num-objects</replaceable>
<prompt>root # </prompt>ceph osd pool set-quota <replaceable>poolname</replaceable> max_bytes <replaceable>num-bytes</replaceable></screen>
     <para>
      或者刪除一些現有資料以減少使用量。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>PG_AVAILABILITY</term>
    <listitem>
     <para>
      資料可用性下降，這表示叢集無法處理針對叢集中某些資料的潛在讀取或寫入要求。具體而言，一或多個 PG 處於不允許處理 IO 要求的狀態。有問題的 PG 狀態包括<emphasis>互聯建立中</emphasis>、<emphasis>陳舊</emphasis>、<emphasis>不完整</emphasis>和不處於<emphasis>使用中</emphasis> (如果不迅速解決這些狀況)。執行以下指令可獲得有關哪些 PG 受影響的詳細資訊︰
     </para>
<screen><prompt>root # </prompt>ceph health detail</screen>
     <para>
      大多數情況下，出現此情形的根本原因在於一或多個 OSD 目前已停機。可使用以下指令來查詢特定的有問題 PG 的狀態︰
     </para>
<screen><prompt>root # </prompt>ceph tell <replaceable>pgid</replaceable> query</screen>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>PG_DEGRADED</term>
    <listitem>
     <para>
      某些資料的資料備援降低，這表示叢集沒有所需數量的複本用於所有資料 (對於副本池) 或糾刪碼片段 (對於糾刪碼池)。具體而言，一或多個 PG 設定了 <emphasis>degraded</emphasis> 或 <emphasis>undersized</emphasis> 旗標 (叢集中沒有該放置群組的足夠例項)，或者有一段時間未設定 <emphasis>clean</emphasis> 旗標。執行以下指令可獲得有關哪些 PG 受影響的詳細資訊︰
     </para>
<screen><prompt>root # </prompt>ceph health detail</screen>
     <para>
      大多數情況下，出現此情形的根本原因在於一或多個 OSD 目前已停機。可使用以下指令來查詢特定的有問題 PG 的狀態︰
     </para>
<screen><prompt>root # </prompt>ceph tell <replaceable>pgid</replaceable> query</screen>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>PG_DEGRADED_FULL</term>
    <listitem>
     <para>
      由於叢集中的可用空間不足，某些資料的資料備援可能已降低或面臨風險。具體而言，一或多個 PG 設定了 <emphasis>backfill_toofull</emphasis> 或 <emphasis>recovery_tooful</emphasis> 旗標，這表示叢集無法移轉或復原資料，原因是一或多個 OSD 高於 <emphasis>backfillfull</emphasis> 閾值。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>PG_DAMAGED</term>
    <listitem>
     <para>
      資料整理 (請參閱<xref linkend="scrubbing"/>) 程序探查到叢集中存在某些資料一致性問題。具體而言，一或多個 PG 設定了 <emphasis>inconsistent</emphasis> 或 <emphasis>snaptrim_error</emphasis> 旗標 (表示某個較早的整理操作發現問題)，或者設定了 <emphasis>repair</emphasis> 旗標 (表示目前正在修復此類不一致問題)。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>OSD_SCRUB_ERRORS</term>
    <listitem>
     <para>
      最近的 OSD 整理操作發現了不一致問題。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>CACHE_POOL_NEAR_FULL</term>
    <listitem>
     <para>
      快取層池將滿。此環境中的「滿」由快取池的 <emphasis>target_max_bytes</emphasis> 和 <emphasis>target_max_objects</emphasis> 內容確定。當池達到目標閾值時，如果正在從快取衝洗和逐出資料，寫入池的要求可能會被阻擋，出現常會導致延遲很高且效能變差的狀態。可使用以下指令調整快取池目標大小︰
     </para>
<screen><prompt>root # </prompt>ceph osd pool set <replaceable>cache-pool-name</replaceable> target_max_bytes <replaceable>bytes</replaceable>
<prompt>root # </prompt>ceph osd pool set <replaceable>cache-pool-name</replaceable> target_max_objects <replaceable>objects</replaceable></screen>
     <para>
      正常的快取衝洗和逐出活動還可能因基礎層級可用性或效能下降或者叢集的整體負載較高而受到限制。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>TOO_FEW_PGS</term>
    <listitem>
     <para>
      使用中的 PG 數量低於每個 OSD 的 PG 數的可設定閾值 <option>mon_pg_warn_min_per_osd</option>。這可能導致叢集中各 OSD 間的資料分發和平衡未達到最佳，以致降低整體效能。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>TOO_MANY_PGS</term>
    <listitem>
     <para>
      使用中的 PG 數量高於每個 OSD 的 PG 數的可設定閾值 <option>mon_pg_warn_max_per_osd</option>。這可能導致 OSD 精靈的記憶體使用率較高，叢集狀態變更 (例如 OSD 重新啟動、新增或移除) 之後互聯速度降低，並且 Ceph manager 和 Ceph monitor 上的負載較高。
     </para>
     <para>
      雖然不能降低現有池的 <option>pg_num</option> 值，但可以降低 <option>pgp_num</option> 值。這樣可有效地將一些 PG 併置在同組 OSD 上，從而減輕上述的一些負面影響。可使用以下指令調整 <option>pgp_num</option> 值︰
     </para>
<screen><prompt>root # </prompt>ceph osd pool set <replaceable>pool</replaceable> pgp_num <replaceable>value</replaceable></screen>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>SMALLER_PGP_NUM</term>
    <listitem>
     <para>
      一或多個池的 <option>pgp_num</option> 值小於 <option>pg_num</option>。這通常表示 PG 計數有所提高，但未同時提升放置行為。使用以下指令設定 <option>pgp_num</option>，使其與觸發資料移轉的 <option>pg_num</option> 相符，通常便可解決此問題︰
     </para>
<screen>ceph osd pool set <replaceable>pool</replaceable> pgp_num <replaceable>pg_num_value</replaceable></screen>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>MANY_OBJECTS_PER_PG</term>
    <listitem>
     <para>
      一或多個池的每 PG 平均物件數大大高於叢集的整體平均值。透過 <option>mon_pg_warn_max_object_skew</option> 組態值來控制該特定閾值。這通常表示包含叢集中大部分資料的池所具有的 PG 太少，以及/或者不包含這麼多資料的其他池具有的 PG 太多。可透過調整監控程式上的 <option>mon_pg_warn_max_object_skew</option> 組態選項提高閾值，來消除該狀態警告。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>POOL_APP_NOT_ENABLED</term>
    <listitem>
     <para>
      存在包含一或多個物件，但尚未標記為供特定應用程式使用的池。將池標記為供某個應用程式使用即可消除此警告。例如，如果池由 RBD 使用︰
     </para>
<screen><prompt>root # </prompt>rbd pool init <replaceable>pool_name</replaceable></screen>
     <para>
      如果池正由自訂應用程式「foo」使用，您還可以使用低層級指令標記它︰
     </para>
<screen><prompt>root # </prompt>ceph osd pool application enable foo</screen>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>POOL_FULL</term>
    <listitem>
     <para>
      一或多個池已達到 (或幾乎要達到) 其定額。透過 <option>mon_pool_quota_crit_threshold</option> 組態選項來控制觸發此錯誤狀況的閾值。可使用以下指令上調、下調 (或移除) 池定額︰
     </para>
<screen><prompt>root # </prompt>ceph osd pool set-quota <replaceable>pool</replaceable> max_bytes <replaceable>bytes</replaceable>
<prompt>root # </prompt>ceph osd pool set-quota <replaceable>pool</replaceable> max_objects <replaceable>objects</replaceable></screen>
     <para>
      將定額值設定為 0 將停用定額。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>POOL_NEAR_FULL</term>
    <listitem>
     <para>
      一或多個池接近其定額。透過 <option>mon_pool_quota_warn_threshold</option> 組態選項來控制觸發此警告狀況的閾值。可使用以下指令上調、下調 (或移除) 池定額︰
     </para>
<screen><prompt>root # </prompt>ceph osd osd pool set-quota <replaceable>pool</replaceable> max_bytes <replaceable>bytes</replaceable>
<prompt>root # </prompt>ceph osd osd pool set-quota <replaceable>pool</replaceable> max_objects <replaceable>objects</replaceable></screen>
     <para>
      將定額值設定為 0 將停用定額。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>OBJECT_MISPLACED</term>
    <listitem>
     <para>
      叢集中的一或多個物件未儲存在叢集希望用於儲存這些物件的節點上。這表示叢集最近的某項變更導致的資料移轉尚未完成。誤放的資料本質上不屬於危險狀況。資料一致性方面永遠不會有風險，僅當所需位置放置了物件所需份數的新副本之後，系統才會移除物件的舊副本。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>OBJECT_UNFOUND</term>
    <listitem>
     <para>
      找不到叢集中的一或多個物件。具體而言，OSD 知道物件的新副本或已更新副本應該存在，但目前在線上的 OSD 上找不到該版本的物件副本。系統將阻擋對「未找到」物件的讀取和寫入要求。理想情況下，系統可將具有未找到物件的最近副本的已停機 OSD 復原線上狀態。可透過負責處理未找到物件的 PG 的互聯狀態識別候選 OSD︰
     </para>
<screen><prompt>root # </prompt>ceph tell <replaceable>pgid</replaceable> query</screen>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>REQUEST_SLOW</term>
    <listitem>
     <para>
      正花費很長的時間處理一或多個 OSD 要求。這可能表示負載極重、儲存裝置速度緩慢或有軟體錯誤。您可以從 OSD 主機上執行以下指令，來查詢有問題的 OSD 上的要求佇列︰
     </para>
<screen><prompt>root # </prompt>ceph daemon osd.<replaceable>id</replaceable> ops</screen>
     <para>
      您可以查看近期最慢的要求摘要︰
     </para>
<screen><prompt>root # </prompt>ceph daemon osd.<replaceable>id</replaceable> dump_historic_ops</screen>
     <para>
      可使用以下指令尋找 OSD 的位置︰
     </para>
<screen><prompt>root # </prompt>ceph osd find osd.<replaceable>id</replaceable></screen>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>REQUEST_STUCK</term>
    <listitem>
     <para>
      已將一或多個 OSD 要求阻擋了很長時間。這表示叢集很長一段時間狀態不佳 (例如沒有足夠的執行中 OSD)，或 OSD 存在一些內部問題。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>PG_NOT_SCRUBBED</term>
    <listitem>
     <para>
      最近未整理 (請參閱<xref linkend="scrubbing"/>) 一或多個 PG。通常每 <option>mon_scrub_interval</option> 秒整理一次 PG，當 <option>mon_warn_not_scrubbed</option> 這類間隔已過但未進行整理時，就會觸發此警告。如果 PG 未標記為清理，系統將不會整理它們。如果 PG 放置錯誤或已降級，就會出現這種情況 (請參閱上文中的 PG_AVAILABILITY 和 PG_DEGRADED)。您可使用以下指令手動對標記為清理的 PG 啟動整理︰
     </para>
<screen><prompt>root # </prompt>ceph pg scrub <replaceable>pgid</replaceable></screen>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>PG_NOT_DEEP_SCRUBBED</term>
    <listitem>
     <para>
      最近未深層整理 (請參閱<xref linkend="scrubbing"/>) 一或多個 PG。通常每 <option>osd_deep_scrub_interval</option> 秒整理一次 PG，當 <option>mon_warn_not_deep_scrubbed</option> 這類間隔已過但未進行整理時，就會觸發此警告。如果 PG 未標記為清理，系統將不會 (深層) 整理它們。如果 PG 放置錯誤或已降級，就會出現這種情況 (請參閱上文中的 PG_AVAILABILITY 和 PG_DEGRADED)。您可使用以下指令手動對標記為清理的 PG 啟動整理︰
     </para>
<screen><prompt>root # </prompt>ceph pg deep-scrub <replaceable>pgid</replaceable></screen>
    </listitem>
   </varlistentry>
  </variablelist>

  <tip>
   <para>
    如果之前為您的組態或金鑰圈指定了非預設位置，則此時可以指定它們的位置︰
   </para>
<screen><prompt>root # </prompt>ceph -c <replaceable>/path/to/conf</replaceable> -k <replaceable>/path/to/keyring</replaceable> health</screen>
  </tip>
 </sect1>
 <sect1 xml:id="monitor-watch">
  <title>監看叢集</title>

  <para>
   您可以使用 <command>ceph -s</command> 瞭解叢集的即時狀態。例如，由一個監控程式和兩個 OSD 組成的微型 Ceph 叢集可在某工作負載正在執行時列印以下內容︰
  </para>

<screen>cluster:
  id:     6586341d-4565-3755-a4fd-b50f51bee248
  health: HEALTH_OK

services:
  mon: 3 daemons, quorum blueshark1,blueshark2,blueshark3
  mgr: blueshark3(active), standbys: blueshark2, blueshark1
  osd: 15 osds: 15 up, 15 in

data:
  pools:   8 pools, 340 pgs
  objects: 537 objects, 1985 MB
  usage:   23881 MB used, 5571 GB / 5595 GB avail
  pgs:     340 active+clean

io:
  client:   100 MB/s rd, 26256 op/s rd, 0 op/s wr</screen>

  <para>
   輸出內容提供了以下資訊︰
  </para>

  <itemizedlist mark="bullet" spacing="normal">
   <listitem>
    <para>
     叢集 ID
    </para>
   </listitem>
   <listitem>
    <para>
     叢集執行狀態
    </para>
   </listitem>
   <listitem>
    <para>
     監控程式地圖版本編號和監控程式仲裁的狀態
    </para>
   </listitem>
   <listitem>
    <para>
     OSD 地圖版本編號和 OSD 的狀態
    </para>
   </listitem>
   <listitem>
    <para>
     放置群組地圖版本
    </para>
   </listitem>
   <listitem>
    <para>
     放置群組和池數量
    </para>
   </listitem>
   <listitem>
    <para>
     所儲存資料<emphasis>理論上的</emphasis>數量和所儲存物件的數量；以及
    </para>
   </listitem>
   <listitem>
    <para>
     所儲存資料的總量。
    </para>
   </listitem>
  </itemizedlist>

  <tip>
   <title>Ceph 計算資料使用量的方式</title>
   <para>
    <literal>used</literal> 值反映實際使用的原始儲存量。<literal>xxx GB / xxx GB</literal> 值表示叢集可用容量 (兩者中的較小數值)，以及叢集的整體儲存容量。理論數量反映在複製所儲存資料或建立其快照前這些資料的大小。因此，實際儲存的資料量一般會超出理論上的儲存量，因為 Ceph 會建立資料的複本，可能還會將儲存容量用於複製和建立快照。
   </para>
  </tip>

  <para>
   顯示即時狀態資訊的其他指令如下︰
  </para>

  <itemizedlist>
   <listitem>
    <para>
     <command>ceph pg stat</command>
    </para>
   </listitem>
   <listitem>
    <para>
     <command>ceph osd pool stats</command>
    </para>
   </listitem>
   <listitem>
    <para>
     <command>ceph df</command>
    </para>
   </listitem>
   <listitem>
    <para>
     <command>ceph df detail</command>
    </para>
   </listitem>
  </itemizedlist>

  <para>
   若要獲得即時更新的資訊，請將以上任何指令 (包括 <command>ceph -s</command>) 放置在等待迴圈中，例如︰
  </para>

<screen><systemitem class="username">root</systemitem>while true ; do ceph -s ; sleep 10 ; done</screen>

  <para>
   如果您看累了，請按 <keycombo><keycap function="control"/><keycap>C</keycap></keycombo>。
  </para>
 </sect1>
 <sect1 xml:id="monitor-stats">
  <title>檢查叢集的使用量統計資料</title>

  <para>
   若要檢查叢集的資料使用量和在各池中的資料分發，可以使用 <command>df</command> 選項。它類似於 Linux <command>df</command>。執行以下項目：
  </para>

<screen><prompt>root # </prompt>ceph df
GLOBAL:
    SIZE       AVAIL      RAW USED     %RAW USED
    55886G     55826G       61731M          0.11
POOLS:
    NAME         ID     USED      %USED     MAX AVAIL     OBJECTS
    testpool     1          0         0        17676G           0
    ecpool       2      4077M      0.01        35352G        2102
    test1        3          0         0        17676G           0
    rbd          4         16         0        17676G           3
    rbd1         5         16         0        17676G           3
    ecpool1      6      5708M      0.02        35352G        2871</screen>

  <para>
   輸出內容的 <literal>GLOBAL</literal> 區段提供叢集用於您資料的儲存量綜覽。
  </para>

  <itemizedlist mark="bullet" spacing="normal">
   <listitem>
    <para>
     <literal>SIZE</literal>︰叢集的整體儲存容量。
    </para>
   </listitem>
   <listitem>
    <para>
     <literal>AVAIL</literal>︰叢集中的可用空間容量。
    </para>
   </listitem>
   <listitem>
    <para>
     <literal>RAW USED</literal>︰已用的原始儲存量。
    </para>
   </listitem>
   <listitem>
    <para>
     <literal>% RAW USED</literal>︰已用的原始儲存量百分比。將此數字與 <literal>full ratio</literal> 和 <literal>near full ratio</literal> 結合使用，可確保您不會用完叢集的容量。如需其他詳細資料，請參閱<link xlink:href="http://docs.ceph.com/docs/master/rados/configuration/mon-config-ref#storage-capacit">儲存容量</link>。
    </para>
    <note>
     <title>叢集填滿程度</title>
     <para>
      原始儲存填滿程度達到 70% - 80%，表示需要向叢集新增新的儲存。較高的使用量可能導致單個 OSD 填滿，叢集處於不良狀態。
     </para>
     <para>
      使用指令 <command>ceph osd df tree</command> 可列出所有 OSD 的填滿程度。
     </para>
    </note>
   </listitem>
  </itemizedlist>

  <para>
   輸出內容的 <literal>POOLS</literal> 區段提供了池清單和每個池的理論使用量。此區段的輸出<emphasis>不</emphasis>反映複本、複製品或快照。例如，如果您儲存含 1MB 資料的物件，理論使用量將是 1MB，但是根據複本、複製品或快照數量，實際使用量可能是 2MB 或更多。
  </para>

  <itemizedlist mark="bullet" spacing="normal">
   <listitem>
    <para>
     <literal>NAME</literal>︰池的名稱。
    </para>
   </listitem>
   <listitem>
    <para>
     <literal>ID</literal>︰池 ID。
    </para>
   </listitem>
   <listitem>
    <para>
     <literal>USED</literal>︰以千位元組 (KB) 計的理論已儲存資料量，如果該數字附加了 M，則以百萬位元組計，如果附加了 G，則以千百萬位元組計。
    </para>
   </listitem>
   <listitem>
    <para>
     <literal>%USED</literal>︰每個池的理論已用儲存百分比。
    </para>
   </listitem>
   <listitem>
    <para>
     <literal>MAX AVAIL</literal>︰給定池中的最大可用空間。
    </para>
   </listitem>
   <listitem>
    <para>
     <literal>OBJECTS</literal>︰每個池的理論已儲存物件數。
    </para>
   </listitem>
  </itemizedlist>

  <note>
   <para>
    POOLS 區段中的數字是理論上的。它們不包括複本、快照或複製品數量。因此，USED 和 %USED 數量之和不會加總到輸出內容 %GLOBAL 區段中的 RAW USED 和 %RAW USED 數量中。
   </para>
  </note>
 </sect1>
 <sect1 xml:id="monitor-status">
  <title>檢查叢集的狀態</title>

  <para>
   若要檢查叢集的狀態，請執行以下指令︰
  </para>

<screen><prompt>root # </prompt>ceph status</screen>

  <para>
   或
  </para>

<screen><prompt>root # </prompt>ceph -s</screen>

  <para>
   在互動模式下，輸入 <command>status</command>，然後按 <keycap function="enter"/>。
  </para>

<screen>ceph&gt; status</screen>

  <para>
   Ceph 將列印叢集狀態。例如，由一個監控程式和兩個 OSD 組成的微型 Ceph 叢集可能會列印以下內容︰
  </para>

<screen>cluster b370a29d-9287-4ca3-ab57-3d824f65e339
 health HEALTH_OK
 monmap e1: 1 mons at {ceph1=10.0.0.8:6789/0}, election epoch 2, quorum 0 ceph1
 osdmap e63: 2 osds: 2 up, 2 in
  pgmap v41332: 952 pgs, 20 pools, 17130 MB data, 2199 objects
        115 GB used, 167 GB / 297 GB avail
               1 active+clean+scrubbing+deep
             951 active+clean</screen>
 </sect1>
 <sect1 xml:id="monitor-osdstatus">
  <title>檢查 OSD 狀態</title>

  <para>
   您可透過執行以下指令來檢查 OSD，以確定它們已啟動且正在執行︰
  </para>

<screen><prompt>root # </prompt>ceph osd stat</screen>

  <para>
   或
  </para>

<screen><prompt>root # </prompt>ceph osd dump</screen>

  <para>
   您也可以根據 OSD 在 CRUSH 地圖中的位置檢視 OSD。
  </para>

<screen><prompt>root # </prompt>ceph osd tree</screen>

  <para>
   Ceph 將列印 CRUSH 樹及主機、它的 OSD、OSD 是否已啟動及其權數。
  </para>

<screen># id    weight  type name       up/down reweight
-1      3       pool default
-3      3               rack mainrack
-2      3                       host osd-host
0       1                               osd.0   up      1
1       1                               osd.1   up      1
2       1                               osd.2   up      1</screen>
 </sect1>
 <sect1 xml:id="storage-bp-monitoring-fullosd">
  <title>檢查填滿的 OSD</title>

  <para>
   Ceph 可阻止您向填滿的 OSD 寫入資料，以防遺失資料。在正常運作的叢集中，當叢集接近其填滿比率時，您會收到警告。<command>mon osd full ratio</command> 預設設為容量的 0.95 (95%)，達到該比率後，叢集會阻止用戶端寫入資料。<command>mon osd nearfull ratio</command> 預設設為容量的 0.85 (85%)，達到該比率時，叢集會產生狀態警告。
  </para>

  <para>
   可透過 <command>ceph health</command> 指令報告填滿的 OSD 節點︰
  </para>

<screen>ceph health
  HEALTH_WARN 1 nearfull osds
  osd.2 is near full at 85%</screen>

  <para>
   或
  </para>

<screen>ceph health
  HEALTH_ERR 1 nearfull osds, 1 full osds
  osd.2 is near full at 85%
  osd.3 is full at 97%</screen>

  <para>
   處理填滿的叢集的最佳方法是新增新的 OSD 節點，以便讓叢集將資料重新分發到新的可用儲存。
  </para>

  <para>
   如果 OSD 因填滿而無法啟動，您可以透過刪除已滿 OSD 中的一些放置群組目錄來刪除一些資料。
  </para>

  <tip>
   <title>防止 OSD 填滿</title>
   <para>
    OSD 變滿 (即用完 100% 的磁碟空間) 之後，往往會迅速當機而不發出警告。管理 OSD 節點時需記住下面幾點提示。
   </para>
   <itemizedlist mark="bullet" spacing="normal">
    <listitem>
     <para>
      每個 OSD 的磁碟空間 (通常掛接於 <filename>/var/lib/ceph/osd/osd-{1,2..}</filename> 下) 需放置在專屬的基礎磁碟或分割區上。
     </para>
    </listitem>
    <listitem>
     <para>
      檢查 Ceph 組態檔案，確定 Ceph 不會將其記錄檔案儲存在專供 OSD 使用的磁碟/分割區上。
     </para>
    </listitem>
    <listitem>
     <para>
      確定沒有其他程序寫入專供 OSD 使用的磁碟/分割區。
     </para>
    </listitem>
   </itemizedlist>
  </tip>
 </sect1>
 <sect1 xml:id="monitor-monstatus">
  <title>檢查監控程式狀態</title>

  <para>
   如果叢集有多個監控程式 (這是很有可能的)，則您應在啟動叢集之後到讀取和/或寫入資料之前的期間檢查監控程式仲裁狀態。有多個監控程式在執行時，仲裁必須存在。您還應該定期檢查監控程式狀態，以確定它們正在執行。
  </para>

  <para>
   若要顯示監控程式地圖，請執行以下指令︰
  </para>

<screen><prompt>root # </prompt>ceph mon stat</screen>

  <para>
   或
  </para>

<screen><prompt>root # </prompt>ceph mon dump</screen>

  <para>
   若要檢查監控程式叢集的仲裁狀態，請執行以下指令︰
  </para>

<screen><prompt>root # </prompt>ceph quorum_status</screen>

  <para>
   Ceph 將傳回仲裁狀態。例如，由三個監控程式組成的 Ceph 叢集可能傳回以下內容︰
  </para>

<screen>{ "election_epoch": 10,
  "quorum": [
        0,
        1,
        2],
  "monmap": { "epoch": 1,
      "fsid": "444b489c-4f16-4b75-83f0-cb8097468898",
      "modified": "2011-12-12 13:28:27.505520",
      "created": "2011-12-12 13:28:27.505520",
      "mons": [
            { "rank": 0,
              "name": "a",
              "addr": "127.0.0.1:6789\/0"},
            { "rank": 1,
              "name": "b",
              "addr": "127.0.0.1:6790\/0"},
            { "rank": 2,
              "name": "c",
              "addr": "127.0.0.1:6791\/0"}
           ]
    }
}</screen>
 </sect1>
 <sect1 xml:id="monitor-pgroupstatus">
  <title>檢查放置群組狀態</title>

  <para>
   放置群組會將物件對應到 OSD。監控放置群組時，您希望它們處於 <literal>active</literal> 和 <literal>clean</literal> 狀態。如需詳細的討論內容，請參閱<link xlink:href="http://docs.ceph.com/docs/master/rados/operations/monitoring-osd-pg">監控 OSD 和放置群組</link>。
  </para>
 </sect1>
 <sect1 xml:id="monitor-adminsocket">
  <title>使用管理通訊端</title>

  <para>
   <remark role="fixme">Maybe give an example use case? No obvious difference to normal ceph command?!</remark>Ceph 管理通訊端可讓您透過通訊端介面查詢精靈。依預設，Ceph 通訊端存放在 <filename>/var/run/ceph</filename> 下。若要透過管理通訊端存取精靈，請登入執行精靈的主機，並使用以下指令︰
  </para>

<screen><prompt>root # </prompt>ceph --admin-daemon /var/run/ceph/<replaceable>socket-name</replaceable></screen>

  <para>
   若要檢視可用的管理通訊端指令，請執行以下指令︰
  </para>

<screen><prompt>root # </prompt>ceph --admin-daemon /var/run/ceph/<replaceable>socket-name</replaceable> help</screen>

  <para>
   使用管理通訊端指令可在執行時期顯示和設定您的組態。如需詳細資料，請參閱<link xlink:href="http://docs.ceph.com/docs/master/rados/configuration/ceph-conf#ceph-runtime-config">在執行時期檢視組態</link>。
  </para>

  <para>
   另外，您也可以直接在執行時期設定組態 (管理通訊端會繞過監控程式，這與 <command>ceph tell</command>
   <replaceable>daemon-type</replaceable>.<replaceable>id</replaceable> injectargs 不同，後者依賴於監控程式，但不需要您直接登入有問題的主機)。
  </para>
 </sect1>
</chapter>
