<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="admin_rbd.xml" version="5.0" xml:id="ceph-rbd">
 <title>Dispositivo de Blocos RADOS</title>
 <info>
      <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
        <dm:translation>sim</dm:translation>
        <dm:release>SES 5</dm:release>
      </dm:docmanager>
    </info>
    <para>
  Um bloco é uma sequência de bytes. Por exemplo, um bloco de dados de 512 bytes. As interfaces de armazenamento com base em blocos são a maneira mais comum para armazenar dados com mídia rotativa, como discos rígidos, CDs e disquetes. A onipresença de interfaces de dispositivo de blocos faz do dispositivo de blocos virtual o candidato ideal para interagir com um sistema de armazenamento de dados em massa, como o Ceph.
 </para>
 <para>
  Os dispositivos de blocos do Ceph permitem o compartilhamento de recursos físicos e são redimensionáveis. Eles armazenam dados distribuídos por vários OSDs em um cluster do Ceph. Os dispositivos de blocos do Ceph aproveitam os recursos do RADOS, como criação de instantâneos, replicação e consistência. Os Dispositivo de Blocos RADOS (RBD) do Ceph interagem com os OSDs usando os módulos do kernel ou a biblioteca <systemitem>librbd</systemitem>.
 </para>
 <figure>
  <title>Protocolo RADOS</title>
  <mediaobject>
   <imageobject role="fo">
    <imagedata fileref="ceph_rbd_schema.png" width="70%" format="PNG"/>
   </imageobject>
   <imageobject role="html">
    <imagedata fileref="ceph_rbd_schema.png" width="70%" format="PNG"/>
   </imageobject>
  </mediaobject>
 </figure>
 <para>
  Os dispositivos de blocos do Ceph oferecem alto desempenho com escalabilidade infinita aos módulos do kernel. Eles suportam soluções de virtualização, como QEMU, ou sistemas de computação com base em nuvem, como OpenStack, que utilizam a <systemitem class="library">libvirt</systemitem>. Você pode usar o mesmo cluster para operar o Object Gateway, o CephFS e os Dispositivos de Blocos RADOS simultaneamente.
 </para>
 <sect1 xml:id="ceph-rbd-commands">
  <title>Comandos do dispositivo de blocos</title>

  <para>
   O comando <command>rbd</command> permite criar, listar, avaliar e remover imagens de dispositivo de blocos. Você também pode usá-lo, por exemplo, para clonar imagens, criar instantâneos, voltar uma imagem para um instantâneo ou ver um instantâneo.
  </para>

  <tip>
   <title>Acesso a um cluster</title>
   <para>
    Para usar os comandos do Dispositivo de Blocos RADOS, você deve ter acesso a um cluster do Ceph ativo.
   </para>
  </tip>

  <sect2 xml:id="ceph-rbd-cmds-create">
   <title>Criando uma imagem de dispositivo de blocos</title>
   <para>
    Antes de adicionar um dispositivo de blocos a um nó, você deve criar uma imagem para ele no cluster. Para criar uma imagem de dispositivo de blocos, execute o seguinte:
   </para>
<screen><prompt>root # </prompt>rbd create --size <replaceable>megabytes</replaceable> <replaceable>pool-name</replaceable>/<replaceable>image-name</replaceable></screen>
   <para>
    Por exemplo, para criar uma imagem de 1 GB denominada “bar” que armazena informações em um pool chamado “swimmingpool”, execute o seguinte:
   </para>
<screen><prompt>root # </prompt>rbd create --size 1024 swimmingpool/bar</screen>
   <tip>
    <title>Pool padrão</title>
    <para>
     Se você não especificar um pool durante a criação de uma imagem, ela será armazenada no pool padrão “rbd”.
    </para>
   </tip>
   <note>
    <title>Criar primeiro o pool</title>
    <para>
     Você precisa primeiro criar um pool antes de especificá-lo como origem. Consulte o <xref linkend="ceph-pools"/> para obter mais detalhes.
    </para>
   </note>
  </sect2>

  <sect2 xml:id="ceph-rbd-cmds-create-ec">
   <title>Criando a imagem de um dispositivo de blocos em um pool com codificação de eliminação</title>
   <para>
    A partir do SUSE Enterprise Storage 5, é possível armazenar dados de uma imagem de dispositivo de blocos em pools com codificação de eliminação. Apenas a parte de “dados” da imagem RBD pode ser armazenada em um pool com codificação de eliminação. Além disso, o pool com codificação de eliminação deve ter o flag “overwrite” definido como <emphasis>true</emphasis>. Apenas será possível definir esse flag como <emphasis>true</emphasis> se todos os OSDs usarem o BlueStore.
   </para>
   <para>
    Os metadados de imagem não podem residir em um pool com codificação de eliminação. Os metadados podem residir no pool “rbd” padrão ou no pool que o usuário especifica explicitamente com o parâmetro <parameter>--pool=</parameter> no comando <command>rbd create</command>.
   </para>
   <note>
    <title>Necessário para o BlueStore</title>
    <para>
     Todos os nós exigem que o BlueStore use pools com codificação de eliminação para imagens de dispositivo de blocos.
    </para>
   </note>
   <para>
    Siga as etapas abaixo para criar uma imagem RBD em um pool com codificação de eliminação:
   </para>
<screen><prompt>root # </prompt><command>ceph</command> osd pool create <replaceable>POOL_NAME</replaceable> 12 12 erasure
<prompt>root # </prompt><command>ceph</command> osd pool set <replaceable>POOL_NAME</replaceable> allow_ec_overwrites true

# Metadata will reside in pool "rbd", and data in pool "<replaceable>POOL_NAME</replaceable>"
<prompt>root # </prompt><command>rbd</command> create <replaceable>IMAGE_NAME</replaceable> --size=1G --data-pool <replaceable>POOL_NAME</replaceable>

#Metadata will reside in pool "<replaceable>OTHER_POOL</replaceable>", and data in pool "<replaceable>POOL_NAME</replaceable>"
<prompt>root # </prompt><command>rbd</command> create <replaceable>IMAGE_NAME</replaceable> --size=1G --data-pool <replaceable>POOL_NAME</replaceable> --pool=<replaceable>OTHER_POOL</replaceable></screen>
  </sect2>

  <sect2 xml:id="ceph-rbd-cmds-list">
   <title>Listando imagens de dispositivo de blocos</title>
   <para>
    Para listar os dispositivos de blocos no pool “rbd”, execute o seguinte (“rbd” é o nome do pool padrão):
   </para>
<screen><prompt>root # </prompt>rbd ls</screen>
   <para>
    Para listar os dispositivos de blocos em um pool chamado “swimmingpool”, execute o seguinte:
   </para>
<screen><prompt>root # </prompt>rbd ls swimmingpool</screen>
  </sect2>

  <sect2 xml:id="ceph-rbd-cmds-info">
   <title>Recuperando informações da imagem</title>
   <para>
    Para recuperar informações da imagem “bar” em um pool chamado “swimmingpool”, execute o seguinte:
   </para>
<screen><prompt>root # </prompt>rbd info swimmingpool/bar</screen>
  </sect2>

  <sect2 xml:id="ceph-rbd-cmds-resize">
   <title>Redimensionando a imagem de um dispositivo de blocos</title>
   <para>
    As imagens de Dispositivo de Blocos RADOS são aprovisionadas dinamicamente, elas não usam nenhum armazenamento físico até você começar a gravar dados nelas. No entanto, elas têm uma capacidade máxima que você define com a opção <option>--size</option>. Para aumentar (ou diminuir) o tamanho máximo da imagem, execute o seguinte:
   </para>
<screen><prompt>root # </prompt>rbd resize --size 2048 foo # to increase
rbd resize --size 2048 foo --allow-shrink # to decrease</screen>
  </sect2>

  <sect2 xml:id="ceph-rbd-cmds-rm">
   <title>Removendo a imagem de um dispositivo de blocos</title>
   <para>
    Para remover um dispositivo de blocos correspondente a uma imagem “bar” no pool chamado “swimmingpool”, execute o seguinte:
   </para>
<screen><prompt>root # </prompt>rbd rm swimmingpool/bar</screen>
  </sect2>
 </sect1>
 <sect1 xml:id="storage-bp-integration-mount-rbd">
  <title>Montando e desmontando imagens RBD</title>

  <para>
   Após criar um Dispositivo de Blocos RADOS, você poderá formatá-lo, montá-lo para poder trocar arquivos e desmontá-lo depois de concluído.
  </para>

  <procedure>
   <step>
    <para>
     Verifique se o cluster do Ceph inclui um pool com a imagem do disco que você deseja montar. Considere o pool chamado <literal>mypool</literal> e a imagem <literal>myimage</literal>.
    </para>
<screen>rbd list mypool</screen>
   </step>
   <step>
    <para>
     Mapeie a imagem para um novo dispositivo de blocos.
    </para>
<screen><prompt>root # </prompt>rbd map --pool mypool myimage</screen>
    <tip>
     <title>Nome e autenticação de usuário</title>
     <para>
      Para especificar um nome de usuário, utilize <option>--id <replaceable>user-name</replaceable></option>. Além disso, se você usar a autenticação <systemitem>cephx</systemitem>, deverá também especificar um segredo. Ele pode vir de um chaveiro ou de um arquivo que contém o segredo:
     </para>
<screen><prompt>root # </prompt>rbd map --pool rbd myimage --id admin --keyring /path/to/keyring</screen>
     <para>
      ou
     </para>
<screen><prompt>root # </prompt>rbd map --pool rbd myimage --id admin --keyfile /path/to/file</screen>
    </tip>
   </step>
   <step>
    <para>
     Liste todos os dispositivos mapeados:
    </para>
<screen><prompt>root # </prompt>rbd showmapped
 id pool   image   snap device
 0  mypool myimage -    /dev/rbd0</screen>
    <para>
     O dispositivo no qual desejamos trabalhar é <filename>/dev/rbd0</filename>.
    </para>
   </step>
   <step>
    <para>
     Crie um sistema de arquivos XFS no dispositivo <filename>/dev/rbd0</filename>.
    </para>
<screen><prompt>root # </prompt>mkfs.xfs /dev/rbd0
 log stripe unit (4194304 bytes) is too large (maximum is 256KiB)
 log stripe unit adjusted to 32KiB
 meta-data=/dev/rbd0              isize=256    agcount=9, agsize=261120 blks
          =                       sectsz=512   attr=2, projid32bit=1
          =                       crc=0        finobt=0
 data     =                       bsize=4096   blocks=2097152, imaxpct=25
          =                       sunit=1024   swidth=1024 blks
 naming   =version 2              bsize=4096   ascii-ci=0 ftype=0
 log      =internal log           bsize=4096   blocks=2560, version=2
          =                       sectsz=512   sunit=8 blks, lazy-count=1
 realtime =none                   extsz=4096   blocks=0, rtextents=0</screen>
   </step>
   <step>
    <para>
     Monte o dispositivo e verifique se ele foi montado corretamente. Substitua <filename>/mnt</filename> pelo ponto de montagem.
    </para>
<screen><prompt>root # </prompt>mount /dev/rbd0 /mnt
<prompt>root # </prompt>mount | grep rbd0
/dev/rbd0 on /mnt type xfs (rw,relatime,attr2,inode64,sunit=8192,...</screen>
    <para>
     Agora, você pode mover os dados de e para o dispositivo como se ele fosse um diretório local.
    </para>
    <tip>
     <title>Aumentando o tamanho do dispositivo RBD</title>
     <para>
      Se você acha que o tamanho do dispositivo RBD não é mais suficiente, pode aumentá-lo com facilidade.
     </para>
     <orderedlist spacing="normal">
      <listitem>
       <para>
        Aumente o tamanho da imagem RBD. Por exemplo, até 10 GB.
       </para>
<screen><prompt>root # </prompt>rbd resize --size 10000 mypool/myimage
 Resizing image: 100% complete...done.</screen>
      </listitem>
      <listitem>
       <para>
        Expanda o sistema de arquivos para preencher o novo tamanho do dispositivo.
       </para>
<screen><prompt>root # </prompt>xfs_growfs /mnt
 [...]
 data blocks changed from 2097152 to 2560000</screen>
      </listitem>
     </orderedlist>
    </tip>
   </step>
   <step>
    <para>
     Após terminar de acessar o dispositivo, você poderá desmontá-lo.
    </para>
<screen><prompt>root # </prompt>unmount /mnt</screen>
   </step>
  </procedure>

  <tip>
   <title>(Des)montagem manual</title>
   <para>
    Como o mapeamento e a montagem manuais de imagens RBD após a inicialização, e a desmontagem e a anulação do mapeamento antes do encerramento, podem ser desgastantes, um script <command>rbdmap</command> e uma unidade <systemitem class="daemon">systemd</systemitem> são fornecidos. Consulte a <xref linkend="ceph-rbd-rbdmap"/>.
   </para>
  </tip>
 </sect1>
 <sect1 xml:id="cha-ceph-snapshots-rbd">
  <title>Instantâneos de dispositivo de blocos</title>

  <para>
   Um instantâneo RBD é aquele de uma imagem do Dispositivo de Blocos RADOS. Com os instantâneos, você pode manter o histórico de estado da imagem. O Ceph também suporta camadas de instantâneo, o que permite clonar imagens de VM de forma rápida e fácil. O Ceph suporta instantâneos de dispositivo de blocos usando o comando <command>rbd</command> e muitas interfaces de nível mais alto, incluindo QEMU, <systemitem>libvirt</systemitem>, OpenStack e CloudStack.
  </para>

  <note>
   <para>
    Pare as operações de entrada e de saída antes de criar instantâneos de uma imagem. Se a imagem tiver um sistema de arquivos, o estado dele deverá ser consistente <emphasis>antes</emphasis> da criação de instantâneos.
   </para>
  </note>

  <sect2>
   <title>Notas sobre o Cephx</title>
   <para>
    Quando o <systemitem>cephx</systemitem> está habilitado (consulte <link xlink:href="http://ceph.com/docs/master/rados/configuration/auth-config-ref/"/> para obter mais informações), você deve especificar um nome de usuário ou ID e um caminho para o chaveiro que contém a chave correspondente para o usuário. Consulte <link xlink:href="http://ceph.com/docs/master/rados/operations/user-management/">Gerenciamento de usuários</link> para obter mais detalhes. É possível também adicionar a variável de ambiente <systemitem>CEPH_ARGS</systemitem> para evitar uma nova entrada dos parâmetros a seguir.
   </para>
<screen><prompt>root # </prompt>rbd --id <replaceable>user-ID</replaceable> --keyring=/path/to/secret <replaceable>commands</replaceable>
<prompt>root # </prompt>rbd --name <replaceable>username</replaceable> --keyring=/path/to/secret <replaceable>commands</replaceable></screen>
   <para>
    Por exemplo:
   </para>
<screen><prompt>root # </prompt>rbd --id admin --keyring=/etc/ceph/ceph.keyring <replaceable>commands</replaceable>
<prompt>root # </prompt>rbd --name client.admin --keyring=/etc/ceph/ceph.keyring <replaceable>commands</replaceable></screen>
   <tip>
    <para>
     Adicione o usuário e o segredo à variável de ambiente <systemitem>CEPH_ARGS</systemitem> para que você não precise digitá-los toda vez.
    </para>
   </tip>
  </sect2>

  <sect2>
   <title>Aspectos básicos do instantâneo</title>
   <para>
    Os procedimentos a seguir demonstram como criar, listar e remover instantâneos usando o comando <command>rbd</command> na linha de comando.
   </para>
   <sect3>
    <title>Criar instantâneos</title>
    <para>
     Para criar um instantâneo com <command>rbd</command>, especifique a opção <option>snap create</option>, o nome do pool e o nome da imagem.
    </para>
<screen><prompt>root # </prompt>rbd --pool <replaceable>pool-name</replaceable> snap create --snap <replaceable>snap-name</replaceable> <replaceable>image-name</replaceable>
<prompt>root # </prompt>rbd snap create <replaceable>pool-name</replaceable>/<replaceable>image-name</replaceable>@<replaceable>snap-name</replaceable></screen>
    <para>
     Por exemplo:
    </para>
<screen><prompt>root # </prompt>rbd --pool rbd snap create --snap snapshot1 image1
<prompt>root # </prompt>rbd snap create rbd/image1@snapshot1</screen>
   </sect3>
   <sect3>
    <title>Listar instantâneos</title>
    <para>
     Para listar os instantâneos de uma imagem, especifique o nome do pool e o nome da imagem.
    </para>
<screen><prompt>root # </prompt>rbd --pool <replaceable>pool-name</replaceable> snap ls <replaceable>image-name</replaceable>
<prompt>root # </prompt>rbd snap ls <replaceable>pool-name</replaceable>/<replaceable>image-name</replaceable></screen>
    <para>
     Por exemplo:
    </para>
<screen><prompt>root # </prompt>rbd --pool rbd snap ls image1
<prompt>root # </prompt>rbd snap ls rbd/image1</screen>
   </sect3>
   <sect3>
    <title>Voltar um instantâneo</title>
    <para>
     Para voltar a um instantâneo com <command>rbd</command>, especifique a opção <option>snap rollback</option>, o nome do pool, o nome da imagem e o nome do instantâneo.
    </para>
<screen><prompt>root # </prompt>rbd --pool <replaceable>pool-name</replaceable> snap rollback --snap <replaceable>snap-name</replaceable> <replaceable>image-name</replaceable>
<prompt>root # </prompt>rbd snap rollback <replaceable>pool-name</replaceable>/<replaceable>image-name</replaceable>@<replaceable>snap-name</replaceable></screen>
    <para>
     Por exemplo:
    </para>
<screen><prompt>root # </prompt>rbd --pool pool1 snap rollback --snap snapshot1 image1
<prompt>root # </prompt>rbd snap rollback pool1/image1@snapshot1</screen>
    <note>
     <para>
      Voltar uma imagem para um instantâneo significa sobregravar a versão atual da imagem com os dados de um instantâneo. O tempo necessário para executar um rollback aumenta de acordo com o tamanho da imagem. É <emphasis>mais rápido clonar</emphasis> de um instantâneo <emphasis>do que voltar</emphasis> uma imagem para um instantâneo, e é o método preferencial para reverter a um estado preexistente.
     </para>
    </note>
   </sect3>
   <sect3>
    <title>Apagar um instantâneo</title>
    <para>
     Para apagar um instantâneo com <command>rbd</command>, especifique a opção <option>snap rm</option>, o nome do pool, o nome da imagem e o nome de usuário.
    </para>
<screen><prompt>root # </prompt>rbd --pool <replaceable>pool-name</replaceable> snap rm --snap <replaceable>snap-name</replaceable> <replaceable>image-name</replaceable>
<prompt>root # </prompt>rbd snap rm <replaceable>pool-name</replaceable>/<replaceable>image-name</replaceable>@<replaceable>snap-name</replaceable></screen>
    <para>
     Por exemplo:
    </para>
<screen><prompt>root # </prompt>rbd --pool pool1 snap rm --snap snapshot1 image1
<prompt>root # </prompt>rbd snap rm pool1/image1@snapshot1</screen>
    <note>
     <para>
      Os Ceph OSDs apagam dados de forma assíncrona, portanto, apagar um instantâneo não libera o espaço em disco imediatamente.
     </para>
    </note>
   </sect3>
   <sect3>
    <title>Purgar instantâneos</title>
    <para>
     Para apagar todos os instantâneos de uma imagem com <command>rbd</command>, especifique a opção <option>snap purge</option> e o nome da imagem.
    </para>
<screen><prompt>root # </prompt>rbd --pool <replaceable>pool-name</replaceable> snap purge <replaceable>image-name</replaceable>
<prompt>root # </prompt>rbd snap purge <replaceable>pool-name</replaceable>/<replaceable>image-name</replaceable></screen>
    <para>
     Por exemplo:
    </para>
<screen><prompt>root # </prompt>rbd --pool pool1 snap purge image1
<prompt>root # </prompt>rbd snap purge pool1/image1</screen>
   </sect3>
  </sect2>

  <sect2 xml:id="ceph-snapshoti-layering">
   <title>Camadas</title>
   <para>
    O Ceph permite criar muitos clones COW (Copy-On-Write – Cópia em Gravação) de um instantâneo de dispositivo de blocos. As camadas de instantâneo permitem que os clientes de dispositivo de blocos do Ceph criem imagens muito rapidamente. Por exemplo, você pode criar uma imagem de dispositivo de blocos com uma VM Linux gravada nela e, em seguida, capturar um instantâneo da imagem, proteger o instantâneo e criar quantos clones de cópia em gravação desejar. Um instantâneo é apenas leitura, portanto, sua clonagem simplifica a semântica, possibilitando criar clones rapidamente.
   </para>
   <note>
    <para>
     Os termos “pai” e “filho” mencionados nos exemplos de linha de comando a seguir indicam um instantâneo de dispositivo de blocos do Ceph (pai) e a imagem correspondente clonada do instantâneo (filho).
    </para>
   </note>
   <para>
    Cada imagem clonada (filho) armazena uma referência à imagem pai, o que permite que a imagem clonada abra o instantâneo pai e o leia.
   </para>
   <para>
    Um clone COW de um instantâneo funciona exatamente como qualquer outra imagem de dispositivo de blocos do Ceph. Você pode ler, gravar, clonar e redimensionar imagens clonadas. Não há nenhuma restrição especial em relação às imagens clonadas. No entanto, o clone de cópia em gravação de um instantâneo refere-se ao instantâneo. Sendo assim, você <emphasis>deve</emphasis> proteger o instantâneo antes de cloná-lo.
   </para>
   <note>
    <para>
     O Ceph suporta apenas a clonagem para imagens <emphasis>format 2</emphasis> (criadas com <command>rbd create --image-format 2</command>).
    </para>
   </note>
   <sect3>
    <title>Introdução às camadas</title>
    <para>
     As camadas de dispositivo de blocos do Ceph são um processo simples. Você deve ter uma imagem. Você deve criar um instantâneo da imagem. Você deve proteger o instantâneo. Após executar essas etapas, você poderá iniciar a clonagem do instantâneo.
    </para>
    <para>
     A imagem clonada tem uma referência ao instantâneo pai e inclui os IDs do pool, da imagem e do instantâneo. A inclusão do ID do pool significa que você pode clonar instantâneos de um pool para imagens em outro pool.
    </para>
    <itemizedlist mark="bullet" spacing="normal">
     <listitem>
      <para>
       <emphasis>Gabarito de Imagem</emphasis>: Um caso de uso comum para camadas de dispositivo de blocos é criar uma imagem master e um instantâneo que serve como gabarito para os clones. Por exemplo, um usuário pode criar uma imagem para uma distribuição Linux (por exemplo, SUSE Linux Enterprise Server) e criar um instantâneo para ela. Periodicamente, o usuário pode atualizar a imagem e criar um novo instantâneo (por exemplo, <command>zypper ref &amp;&amp; zypper patch</command> seguido por <command>rbd snap create</command>). Durante a maturação da imagem, o usuário pode clonar qualquer um dos instantâneos.
      </para>
     </listitem>
     <listitem>
      <para>
       <emphasis>Gabarito Estendido</emphasis>: Um caso de uso mais avançado inclui estender a imagem de um gabarito que fornece mais informações do que uma imagem de base. Por exemplo, um usuário pode clonar uma imagem (um gabarito de VM) e instalar outro software (por exemplo, um banco de dados, um sistema de gerenciamento de conteúdo ou um sistema de análise) e, em seguida, capturar um instantâneo da imagem estendida que, por si só, pode ser atualizada da mesma forma que a imagem de base.
      </para>
     </listitem>
     <listitem>
      <para>
       <emphasis>Pool de Gabarito</emphasis>: Uma maneira de usar as camadas de dispositivo de blocos é criar um pool que contém imagens master que atuam como gabaritos e instantâneos desses gabaritos. Em seguida, você pode estender os privilégios apenas leitura aos usuários para que eles possam clonar os instantâneos sem a capacidade de gravação ou execução no pool.
      </para>
     </listitem>
     <listitem>
      <para>
       <emphasis>Migração/Recuperação de Imagens</emphasis>: Uma maneira de usar as camadas de dispositivo de blocos é migrar ou recuperar os dados de um pool para outro.
      </para>
     </listitem>
    </itemizedlist>
   </sect3>
   <sect3>
    <title>Protegendo um instantâneo</title>
    <para>
     Os clones acessam os instantâneos pai. Todos os clones serão destruídos se um usuário apagar o instantâneo pai por engano. Para evitar a perda de dados, você precisa proteger o instantâneo antes de cloná-lo.
    </para>
<screen><prompt>root # </prompt>rbd --pool <replaceable>pool-name</replaceable> snap protect \
 --image <replaceable>image-name</replaceable> --snap <replaceable>snapshot-name</replaceable>
<prompt>root # </prompt>rbd snap protect <replaceable>pool-name</replaceable>/<replaceable>image-name</replaceable>@<replaceable>snapshot-name</replaceable></screen>
    <para>
     Por exemplo:
    </para>
<screen><prompt>root # </prompt>rbd --pool pool1 snap protect --image image1 --snap snapshot1
<prompt>root # </prompt>rbd snap protect pool1/image1@snapshot1</screen>
    <note>
     <para>
      Você não pode apagar um instantâneo protegido.
     </para>
    </note>
   </sect3>
   <sect3>
    <title>Clonando um instantâneo</title>
    <para>
     Para clonar um instantâneo, você precisa especificar o pool pai, a imagem, o instantâneo, o pool filho e o nome da imagem. Você precisa proteger o instantâneo antes de cloná-lo.
    </para>
<screen><prompt>root # </prompt>rbd --pool <replaceable>pool-name</replaceable> --image <replaceable>parent-image</replaceable> \
 --snap <replaceable>snap-name</replaceable> --dest-pool <replaceable>pool-name</replaceable> \
 --dest <replaceable>child-image</replaceable>
<prompt>root # </prompt>rbd clone <replaceable>pool-name</replaceable>/<replaceable>parent-image</replaceable>@<replaceable>snap-name</replaceable> \
<replaceable>pool-name</replaceable>/<replaceable>child-image-name</replaceable></screen>
    <para>
     Por exemplo:
    </para>
<screen><prompt>root # </prompt>rbd clone pool1/image1@snapshot1 pool1/image2</screen>
    <note>
     <para>
      Você pode clonar um instantâneo de um pool para uma imagem em outro pool. Por exemplo, você pode manter as imagens e os instantâneos apenas leitura como gabaritos em um pool e os clones graváveis em outro pool.
     </para>
    </note>
   </sect3>
   <sect3>
    <title>Anulando a proteção de um instantâneo</title>
    <para>
     Antes de apagar um instantâneo, você deve anular a proteção dele. Além disso, você <emphasis>não</emphasis> pode apagar instantâneos com referências de clones. Você precisa nivelar cada clone de um instantâneo antes de apagar o instantâneo.
    </para>
<screen><prompt>root # </prompt>rbd --pool <replaceable>pool-name</replaceable> snap unprotect --image <replaceable>image-name</replaceable> \
 --snap <replaceable>snapshot-name</replaceable>
<prompt>root # </prompt>rbd snap unprotect <replaceable>pool-name</replaceable>/<replaceable>image-name</replaceable>@<replaceable>snapshot-name</replaceable></screen>
    <para>
     Por exemplo:
    </para>
<screen><prompt>root # </prompt>rbd --pool pool1 snap unprotect --image image1 --snap snapshot1
<prompt>root # </prompt>rbd snap unprotect pool1/image1@snapshot1</screen>
   </sect3>
   <sect3>
    <title>Listando os filhos de um instantâneo</title>
    <para>
     Para listar os filhos de um instantâneo, execute o seguinte:
    </para>
<screen><prompt>root # </prompt>rbd --pool <replaceable>pool-name</replaceable> children --image <replaceable>image-name</replaceable> --snap <replaceable>snap-name</replaceable>
<prompt>root # </prompt>rbd children <replaceable>pool-name</replaceable>/<replaceable>image-name</replaceable>@<replaceable>snapshot-name</replaceable></screen>
    <para>
     Por exemplo:
    </para>
<screen><prompt>root # </prompt>rbd --pool pool1 children --image image1 --snap snapshot1
<prompt>root # </prompt>rbd children pool1/image1@snapshot1</screen>
   </sect3>
   <sect3>
    <title>Nivelando uma imagem clonada</title>
    <para>
     As imagens clonadas mantêm uma referência ao instantâneo pai. Ao remover a referência do clone filho para o instantâneo pai, você “nivela” com eficiência a imagem copiando as informações do instantâneo para o clone. O tempo necessário para nivelar um clone aumenta de acordo com o tamanho do instantâneo. Para apagar um instantâneo, você deve primeiro nivelar as imagens filho.
    </para>
<screen><prompt>root # </prompt>rbd --pool <replaceable>pool-name</replaceable> flatten --image <replaceable>image-name</replaceable>
<prompt>root # </prompt>rbd flatten <replaceable>pool-name</replaceable>/<replaceable>image-name</replaceable></screen>
    <para>
     Por exemplo:
    </para>
<screen><prompt>root # </prompt>rbd --pool pool1 flatten --image image1
<prompt>root # </prompt>rbd flatten pool1/image1</screen>
    <note>
     <para>
      Como uma imagem nivelada contém todas as informações do instantâneo, ela ocupa mais espaço de armazenamento do que um clone em camadas.
     </para>
    </note>
   </sect3>
  </sect2>
 </sect1>
 <sect1 xml:id="ceph-rbd-rbdmap">
  <title>rbdmap: Mapear dispositivos RBD no momento da inicialização</title>

  <para>
   <command>rbdmap</command> é um script de shell que automatiza as operações <command>rbd map</command> e <command>rbd unmap</command> em uma ou mais imagens de Dispositivo de Blocos RADOS. Embora você possa executar o script manualmente a qualquer momento, o caso de uso principal é mapear e montar automaticamente as imagens RBD no momento da inicialização (e desmontar e anular o mapeamento no encerramento), conforme acionado pelo sistema Init. Um arquivo da unidade <systemitem class="daemon">systemd</systemitem>, <filename>rbdmap.service</filename>, está incluído no pacote <systemitem>ceph-common</systemitem> para essa finalidade.
  </para>

  <para>
   O script aplica um único argumento, que pode ser <option>map</option> ou <option>unmap</option>. Em qualquer um dos casos, o script analisa um arquivo de configuração. Ele assume como padrão <filename>/etc/ceph/rbdmap</filename>, mas pode ser anulado por meio de uma variável de ambiente <literal>RBDMAPFILE</literal>. Cada linha do arquivo de configuração corresponde a uma imagem RBD que será mapeada ou que terá o mapeamento anulado.
  </para>

  <para>
   O arquivo de configuração tem o seguinte formato:
  </para>

<screen>image_specification rbd_options</screen>

  <variablelist>
   <varlistentry>
    <term>image_specification</term>
    <listitem>
     <para>
      Caminho para uma imagem em um pool. Especifique como <replaceable>nome_do_pool</replaceable>/<replaceable>nome_da_imagem</replaceable>. Se você omitir <replaceable>nome_do_pool</replaceable>, o padrão “rbd” será assumido.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>rbd_options</term>
    <listitem>
     <para>
      Uma lista opcional de parâmetros a serem passados para o comando <command>rbd map</command> subjacente. Esses parâmetros e seus valores devem ser especificados como uma string separada por vírgula. Por exemplo:
     </para>
<screen>PARAM1=VAL1,PARAM2=VAL2,...</screen>
     <para>
      O exemplo faz com que o script <command>rbdmap</command> execute o seguinte comando:
     </para>
<screen>rbd map <replaceable>pool_name</replaceable>/<replaceable>image_name</replaceable> --PARAM1 VAL1 --PARAM2 VAL2</screen>
    </listitem>
   </varlistentry>
  </variablelist>

  <para>
   Quando executado como <command>rbdmap map</command>, o script analisa o arquivo de configuração e, para cada imagem RBD especificada, ele tenta primeiro mapear a imagem (usando o comando <command>rbd map</command>) e, na sequência, montar a imagem.
  </para>

  <para>
   Quando executado como <command>rbdmap unmap</command>, as imagens listadas no arquivo de configuração serão desmontadas e o mapeamento delas será anulado.
  </para>

  <para>
   <command>rbdmap unmap-all</command> tenta desmontar e, na sequência, anular o mapeamento de todas as imagens RBD mapeadas, independentemente de estarem listadas no arquivo de configuração.
  </para>

  <para>
   Se bem-sucedida, a operação rbd map mapeia a imagem para um dispositivo /dev/rbdX e, nesse ponto, uma regra udev é acionada para criar um link simbólico do nome do dispositivo amigável <filename>/dev/rbd/<replaceable>nome_do_pool</replaceable>/<replaceable>nome_da_imagem</replaceable></filename> apontando para o dispositivo real mapeado.
  </para>

  <para>
   Para que a montagem e a desmontagem sejam bem-sucedidas, o nome “amigável” do dispositivo precisa ter uma entrada correspondente em <filename>/etc/fstab</filename>. Ao gravar entradas <filename>/etc/fstab</filename> em imagens RBD, especifique a opção de montagem “noauto” (ou “nofail”). Isso impede que o sistema Init tente montar o dispositivo com muita antecedência, antes mesmo de ele existir, pois <filename>rbdmap.service</filename> é normalmente acionado mais adiante na sequência de boot.
  </para>

  <para>
   Para obter uma lista de opções <command>rbd</command>, consulte a página de manual do <command>rbd</command> (<command>man 8 rbd</command>).
  </para>

  <para>
   Para ver exemplos de uso do <command>rbdmap</command>, consulte a página de manual do <command>rbdmap</command> (<command>man 8 rbdmap</command>).
  </para>
 </sect1>
 <sect1 xml:id="ceph-rbd-mirror">
  <title>Espelhamento de dispositivo de blocos RADOS</title>

  <para>
   É possível espelhar as imagens RBD de forma assíncrona entre dois clusters do Ceph. Essa funcionalidade usa o recurso de registro de imagens RBD em diário para garantir a replicação consistente com a falha entre os clusters. O espelhamento é configurado por pool nos clusters peer e pode ser configurado para espelhar automaticamente todas as imagens em um pool ou apenas um subconjunto específico de imagens. O espelhamento é configurado usando o comando <command>rbd</command>. O daemon <systemitem>rbd-mirror</systemitem> é responsável por capturar as atualizações da imagem do cluster peer remoto e aplicá-las à imagem no cluster local.
  </para>

  <important>
   <title>Daemon rbd-mirror</title>
   <para>
    Para usar o espelhamento de RBD, você precisa ter dois clusters do Ceph, cada um executando o daemon <systemitem>rbd-mirror</systemitem>.
   </para>
  </important>

  <sect2 xml:id="rbd-mirror-daemon">
   <title>Daemon rbd-mirror</title>
   <para>
    Os dois daemons <systemitem>rbd-mirror</systemitem> são responsáveis por observar os diários da imagem no cluster peer remoto e reproduzir os eventos do diário no cluster local. O recurso de registro de imagens RBD em diário registra todas as modificações feitas na imagem na ordem em que elas ocorrem. Isso garante que um espelho da imagem remota consistente com a falha esteja disponível localmente.
   </para>
   <para>
    O daemon <systemitem>rbd-mirror</systemitem> está disponível no pacote <systemitem>rbd-mirror</systemitem>. Instale, habilite e inicie-o em um dos nós do cluster:
   </para>
<screen><prompt>root@minion &gt; </prompt>zypper install rbd-mirror
<prompt>root@minion &gt; </prompt>systemctl enable ceph-rbd-mirror@<replaceable>server_name</replaceable>.service
<prompt>root@minion &gt; </prompt>systemctl start ceph-rbd-mirror@<replaceable>server_name</replaceable>.service</screen>
   <important>
    <para>
     Cada daemon <systemitem>rbd-mirror</systemitem> requer conexão com os dois clusters simultaneamente.
    </para>
   </important>
  </sect2>

  <sect2 xml:id="ceph-rbd-mirror-poolconfig">
   <title>Configuração do pool</title>
   <para>
    Os procedimentos a seguir demonstram como executar as tarefas administrativas básicas para configurar o espelhamento usando o comando <command>rbd</command>. O espelhamento é configurado por pool nos clusters do Ceph.
   </para>
   <para>
    Você precisa executar as etapas de configuração do pool em ambos os clusters peer. Estes procedimentos consideram a existência de dois clusters, chamados "local" e "remote", acessíveis de um único host, por motivos de clareza.
   </para>
   <para>
    Consulte a página de manual do <command>rbd</command> (<command>man 8 rbd</command>) para obter mais detalhes sobre como se conectar a diferentes clusters do Ceph.
   </para>
   <tip>
    <title>Vários clusters</title>
    <para>
     O nome do cluster nos exemplos a seguir corresponde a um arquivo de configuração do Ceph de mesmo nome <filename>/etc/ceph/remote.conf</filename>. Consulte a documentação do <link xlink:href="http://docs.ceph.com/docs/master/rados/configuration/ceph-conf/#running-multiple-clusters">ceph-conf</link> para saber como configurar vários clusters.
    </para>
   </tip>
   <sect3>
    <title>Habilitar o espelhamento</title>
    <para>
     Para habilitar o espelhamento em um pool, especifique o subcomando <command>mirror pool enable</command>, o nome do pool e o modo de espelhamento. O modo de espelhamento pode ser pool ou image:
    </para>
    <variablelist>
     <varlistentry>
      <term>pool</term>
      <listitem>
       <para>
        Todas as imagens no pool com o recurso de registro em diário habilitado são espelhadas.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>image</term>
      <listitem>
       <para>
        O espelhamento precisa ser habilitado explicitamente em cada imagem. Consulte a <xref linkend="rbd-mirror-enable-image-mirroring"/> para obter mais informações.
       </para>
      </listitem>
     </varlistentry>
    </variablelist>
    <para>
     Por exemplo:
    </para>
<screen><prompt>root # </prompt>rbd --cluster local mirror pool enable image-pool pool
<prompt>root # </prompt>rbd --cluster remote mirror pool enable image-pool pool</screen>
   </sect3>
   <sect3>
    <title>Desabilitar o espelhamento</title>
    <para>
     Para desabilitar o espelhamento em um pool, especifique o subcomando <command>mirror pool disable</command> e o nome do pool. Quando o espelhamento é desabilitado dessa maneira em um pool, ele também é desabilitado em todas as imagens (no pool) para as quais ele foi explicitamente habilitado.
    </para>
<screen><prompt>root # </prompt>rbd --cluster local mirror pool disable image-pool
<prompt>root # </prompt>rbd --cluster remote mirror pool disable image-pool</screen>
   </sect3>
   <sect3>
    <title>Adicionar peer de clusters</title>
    <para>
     Para que o daemon <systemitem>rbd-mirror</systemitem> descubra seu cluster peer, o peer precisa ser registrado no pool. Para adicionar um cluster peer de espelhamento, especifique o subcomando <command>mirror pool peer add</command>, o nome do pool e uma especificação do cluster:
    </para>
<screen><prompt>root # </prompt>rbd --cluster local mirror pool peer add image-pool client.remote@remote
<prompt>root # </prompt>rbd --cluster remote mirror pool peer add image-pool client.local@local</screen>
   </sect3>
   <sect3>
    <title>Remover peer de clusters</title>
    <para>
     Para remover um cluster peer de espelhamento, especifique o subcomando <command>mirror pool peer remove</command>, o nome do pool e o UUID do peer (disponível no comando <command>rbd mirror pool info</command>):
    </para>
<screen><prompt>root # </prompt>rbd --cluster local mirror pool peer remove image-pool \
 55672766-c02b-4729-8567-f13a66893445
<prompt>root # </prompt>rbd --cluster remote mirror pool peer remove image-pool \
 60c0e299-b38f-4234-91f6-eed0a367be08</screen>
   </sect3>
  </sect2>

  <sect2 xml:id="rbd-mirror-imageconfig">
   <title>Configuração da imagem</title>
   <para>
    Diferentemente da configuração do pool, a configuração da imagem precisa apenas ser executada em um único cluster peer de espelhamento do Ceph.
   </para>
   <para>
    As imagens RBD espelhadas são designadas como <emphasis>principais</emphasis> ou <emphasis>não principais</emphasis>. Essa é uma propriedade da imagem, e não do pool. Não é possível modificar as imagens designadas como não principais.
   </para>
   <para>
    As imagens são automaticamente promovidas a principais quando o espelhamento é habilitado primeiro em uma imagem (seja implicitamente, se o modo de espelhamento do pool for “pool” e a imagem tiver o recurso de registro de imagens em diário habilitado, ou explicitamente (consulte a <xref linkend="rbd-mirror-enable-image-mirroring"/>) pelo comando <command>rbd</command>).
   </para>
   <sect3>
    <title>Habilitar o suporte ao registro de imagens em diário</title>
    <para>
     O espelhamento de RBD usa o recurso de registro de RBD em diário para garantir que a imagem replicada permaneça sempre consistente com a falha. Antes de espelhar uma imagem para um cluster peer, o recurso de registro em diário deve ser habilitado. O recurso pode ser habilitado no momento da criação da imagem inserindo a opção <option>--image-feature exclusive-lock,journaling</option> no comando <command>rbd</command>.
    </para>
    <para>
     Se preferir, o recurso de registro em diário pode ser habilitado dinamicamente nas imagens RBD preexistentes. Para habilitar o registro em diário, especifique o subcomando <command>feature enable</command>, o nome do pool e da imagem e o nome do recurso:
    </para>
<screen><prompt>root # </prompt>rbd --cluster local feature enable image-pool/image-1 journaling</screen>
    <note>
     <title>Dependência de opção</title>
     <para>
      O recurso de <option>registro em diário</option> depende do recurso de <option>bloqueio exclusivo</option>. Se o recurso de <option>bloqueio exclusivo</option> ainda não estiver habilitado, você precisará habilitá-lo antes de habilitar o recurso de <option>registro em diário</option>.
     </para>
    </note>
    <tip>
     <title>Registrando todas as novas imagens em diário</title>
     <para>
      Você pode habilitar o registro em diário em todas as novas imagens por padrão adicionando a seguinte linha ao arquivo de configuração do Ceph:
     </para>
<screen>rbd default features = 125</screen>
    </tip>
   </sect3>
   <sect3 xml:id="rbd-mirror-enable-image-mirroring">
    <title>Habilitar o espelhamento de imagem</title>
    <para>
     Se o espelhamento for configurado no modo “image” para o pool da imagem, será necessário habilitar explicitamente o espelhamento para cada imagem no pool. Para habilitar o espelhamento em determinada imagem, especifique o subcomando <command>mirror image enable</command> juntamente com o nome do pool e da imagem:
    </para>
<screen><prompt>root # </prompt>rbd --cluster local mirror image enable image-pool/image-1</screen>
   </sect3>
   <sect3>
    <title>Desabilitar o espelhamento de imagem</title>
    <para>
     Para desabilitar o espelhamento em determinada imagem, especifique o subcomando <command>mirror image disable</command> juntamente com o nome do pool e da imagem:
    </para>
<screen><prompt>root # </prompt>rbd --cluster local mirror image disable image-pool/image-1</screen>
   </sect3>
   <sect3>
    <title>Promoção e rebaixamento de imagem</title>
    <para>
     Em um cenário de failover em que a designação principal precisa ser movida para a imagem no cluster peer, você precisa interromper o acesso à imagem principal, rebaixar a imagem principal atual, promover a nova imagem principal e continuar o acesso à imagem no cluster alternativo.
    </para>
    <para>
     Para rebaixar determinada imagem para não principal, especifique o subcomando <command>mirror image demote</command> juntamente com o nome do pool e da imagem:
    </para>
<screen><prompt>root # </prompt>rbd --cluster local mirror image demote image-pool/image-1</screen>
    <para>
     Para rebaixar todas as imagens principais em um pool para não principais, especifique o subcomando <command>mirror pool demote</command> juntamente com o nome do pool:
    </para>
<screen><prompt>root # </prompt>rbd --cluster local mirror pool demote image-pool</screen>
    <para>
     Para promover determinada imagem para principal, especifique o subcomando <command>mirror image promote</command> juntamente com o nome do pool e da imagem:
    </para>
<screen><prompt>root # </prompt>rbd --cluster remote mirror image promote image-pool/image-1</screen>
    <para>
     Para promover todas as imagens não principais em um pool para principais, especifique o subcomando <command>mirror pool promote</command> juntamente com o nome do pool:
    </para>
<screen><prompt>root # </prompt>rbd --cluster local mirror pool promote image-pool</screen>
    <tip>
     <title>Dividir a carga de E/S</title>
     <para>
      Como o status principal ou não principal refere-se a cada imagem, é possível ter dois clusters que dividem a carga de E/S e o failover ou failback por fase.
     </para>
    </tip>
    <note>
     <title>Promoção forçada</title>
     <para>
      A promoção pode ser forçada usando a opção <option>--force</option>. A promoção forçada é necessária quando o rebaixamento não pode ser propagado para o cluster peer (por exemplo, em caso de falha do cluster ou interrupção da comunicação). Isso resultará em um cenário de split-brain (dupla personalidade) entre os dois peers, e a imagem não será mais sincronizada até que um subcomando <command>resync</command> seja emitido.
     </para>
    </note>
   </sect3>
   <sect3>
    <title>Forçar ressincronização de imagem</title>
    <para>
     Se um evento de split-brain for detectado pelo daemon <systemitem>rbd-mirror</systemitem>, ele não tentará espelhar a imagem afetada até o problema ser corrigido. Para continuar o espelhamento de uma imagem, primeiro rebaixe a imagem que foi identificada como desatualizada e, em seguida, solicite uma ressincronização com a imagem principal. Para solicitar a ressincronização de uma imagem, especifique o subcomando <command>mirror image resync</command> juntamente com o nome do pool e da imagem:
    </para>
<screen><prompt>root # </prompt>rbd mirror image resync image-pool/image-1</screen>
   </sect3>
  </sect2>

  <sect2 xml:id="rbd-mirror-status">
   <title>Status do espelho</title>
   <para>
    O status de replicação do cluster peer é armazenado para cada imagem principal espelhada. Esse status pode ser recuperado usando os subcomandos <command>mirror image status</command> e <command>mirror pool status</command>:
   </para>
   <para>
    Para solicitar o status da imagem de espelho, especifique o subcomando <command>mirror image status</command> juntamente com o nome do pool e da imagem:
   </para>
<screen><prompt>root # </prompt>rbd mirror image status image-pool/image-1</screen>
   <para>
    Para solicitar o status do resumo do pool de espelhos, especifique o subcomando <command>mirror pool status</command> juntamente com o nome do pool:
   </para>
<screen><prompt>root # </prompt>rbd mirror pool status image-pool</screen>
   <tip>
    <title/>
    <para>
     A adição da opção <option>--verbose</option> ao subcomando <command>mirror pool status</command> resultará também nos detalhes de status para cada imagem de espelhamento no pool.
    </para>
   </tip>
  </sect2>
 </sect1>
</chapter>
