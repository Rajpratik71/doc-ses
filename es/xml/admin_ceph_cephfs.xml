<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="admin_ceph_cephfs.xml" version="5.0" xml:id="cha-ceph-cephfs">


 <title>Sistema de archivos con agrupación en clúster</title>
 <info>
      <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
        <dm:maintainer>tbazant@suse.com</dm:maintainer>
        <dm:status>editar</dm:status>
        <dm:deadline/>
        <dm:priority/>
        <dm:translation>sí</dm:translation>
        <dm:languages/>
        <dm:release>SES 5</dm:release>
      </dm:docmanager>
    </info>
    <para>
  En este capítulo se describen las tareas de administración que normalmente se llevan a cabo después de configurar el clúster y exportar CephFS. Si necesita más información sobre cómo configurar CephFS, consulte <xref linkend="cha-ceph-as-cephfs"/>.
 </para>
 <sect1 xml:id="ceph-cephfs-cephfs-mount">
  <title>Montaje de CephFS</title>

  <para>
   Cuando se crea el sistema de archivos y el servidor de metadatos está activo, estará preparado para montar el sistema de archivos desde un host de cliente.
  </para>

  <sect2 xml:id="cephfs-client-preparation">
   <title>Preparación del cliente</title>
   <para>
    Si el host de cliente ejecuta SUSE Linux Enterprise 12 SP2 o SP3, puede omitir esta sección, ya que el sistema está preparado para montar CephFS sin preparativos adicionales.
   </para>
   <para>
    Si el host de cliente ejecuta SUSE Linux Enterprise 12 SP1, debe aplicar todos los parches más recientes antes de montar CephFS.
   </para>
   <para>
    En cualquier caso, todo lo necesario para montar CephFS se incluye en SUSE Linux Enterprise. El producto SUSE Enterprise Storage no es necesario.
   </para>
   <para>
    Para admitir la sintaxis completa de <command>mount</command>, el paquete
    <package>ceph-common</package> (que se incluye con SUSE Linux Enterprise) debe estar instalado antes de intentar montar CephFS.
   </para>
  </sect2>

  <sect2 xml:id="Creating-Secret-File">
   <title>Creación de un archivo de secreto</title>
   <para>
    El clúster de Ceph se ejecuta con la autenticación activada por defecto. Debe crear un archivo donde se almacene la clave de secreto (no el anillo de claves en sí). Para obtener la clave de secreto para un usuario concreto y, a continuación, crear el archivo, haga lo siguiente:
   </para>
   <procedure>
    <title>Creación de una clave de secreto</title>
    <step>
     <para>
      Muestre la clave para el usuario concreto en un archivo de anillo de claves:
     </para>
<screen>cat /etc/ceph/ceph.client.admin.keyring</screen>
    </step>
    <step>
     <para>
      Copie la clave del usuario que va a utilizar el sistema de archivos CephFS montado. Normalmente, la clave tiene un aspecto similar al siguiente:
     </para>
<screen>AQCj2YpRiAe6CxAA7/ETt7Hcl9IyxyYciVs47w==</screen>
    </step>
    <step>
     <para>
      Cree un archivo con el nombre de usuario como parte del nombre de archivo; por ejemplo, <filename>/etc/ceph/admin.secret</filename> para el usuario <emphasis>admin</emphasis>.
     </para>
    </step>
    <step>
     <para>
      Pegue el valor de la clave en el archivo creado en el paso anterior.
     </para>
    </step>
    <step>
     <para>
      Defina los derechos de acceso adecuados en el archivo. El usuario debe ser el único que pueda leer el archivo: los demás usuarios no deben tener ningún derecho de acceso.
     </para>
    </step>
   </procedure>
  </sect2>

  <sect2 xml:id="ceph-cephfs-krnldrv">
   <title>Montaje de CephFS</title>
   <para>
    Puede montar CephFS con el comando <command>mount</command>. Es preciso especificar el nombre de host o la dirección IP del monitor. Dado que la autenticación <systemitem>cephx</systemitem> está habilitada por defecto en SUSE Enterprise Storage, debe especificar también un nombre de usuario y su secreto relacionado:
   </para>
<screen>sudo mount -t ceph ceph_mon1:6789:/ /mnt/cephfs \
 -o name=admin,secret=AQATSKdNGBnwLhAAnNDKnH65FmVKpXZJVasUeQ==</screen>
   <para>
    Como el comando anterior permanece en el historial de shell, un enfoque más seguro es leer el secreto desde un archivo:
   </para>
<screen>sudo mount -t ceph ceph_mon1:6789:/ /mnt/cephfs \
 -o name=admin,secretfile=/etc/ceph/admin.secret</screen>
   <para>
    Tenga en cuenta que el archivo de secreto solo debe contener el secreto del anillo de claves actual. En nuestro ejemplo, el archivo solo contendrá la línea siguiente:
   </para>
<screen>AQATSKdNGBnwLhAAnNDKnH65FmVKpXZJVasUeQ==</screen>
   <tip>
    <title>especificación de varios monitores</title>
    <para>
     Resulta recomendable especificar varios monitores separados por comas en la línea del comando <command>mount</command> por si un monitor se desactiva en algún momento del montaje. Las direcciones de los monitores tiene el formato <literal>host[:puerto]</literal>. Si no se especifica el puerto, se utiliza por defecto el 6789.
    </para>
   </tip>
   <para>
    Cree el punto de montaje en el host local:
   </para>
<screen>sudo mkdir /mnt/cephfs</screen>
   <para>
    Monte CephFS:
   </para>
<screen>sudo mount -t ceph ceph_mon1:6789:/ /mnt/cephfs \
 -o name=admin,secretfile=/etc/ceph/admin.secret</screen>
   <para>
    Es posible especificar un subdirectorio <filename>subdir</filename> si se va a montar un subconjunto del sistema de archivos:
   </para>
<screen>sudo mount -t ceph ceph_mon1:6789:/subdir /mnt/cephfs \
 -o name=admin,secretfile=/etc/ceph/admin.secret</screen>
   <para>
    Puede especificar más de un host de monitor en el comando <command>mount</command>:
   </para>
<screen>sudo mount -t ceph ceph_mon1,ceph_mon2,ceph_mon3:6789:/ /mnt/cephfs \
 -o name=admin,secretfile=/etc/ceph/admin.secret</screen>
   <important>
    <title>acceso de lectura al directorio raíz</title>
    <para>
     Si se usan clientes con restricciones de vía, es preciso incluir acceso de lectura al directorio raíz en los permisos del servidor de metadatos. Por ejemplo, un anillo de claves puede tener este aspecto:
    </para>
<screen>client.bar
 key: supersecretkey
 caps: [mds] allow rw path=/barjail, allow r path=/
 caps: [mon] allow r
 caps: [osd] allow rwx</screen>
    <para>
     La parte <literal>allow r path=/</literal> significa que los clientes que tienen vías restringidas podrán ver el volumen raíz, pero no escribir en él. Esto puede ser un problema para los casos en los que se requiera aislamiento completo.
    </para>
   </important>
  </sect2>
 </sect1>
 <sect1 xml:id="ceph-cephfs-cephfs-unmount">
  <title>Desmontaje de CephFS</title>

  <para>
   Para desmontar CephFS, utilice el comando <command>umount</command>:
  </para>

<screen>sudo umount /mnt/cephfs</screen>
 </sect1>
 <sect1 xml:id="ceph-cephfs-cephfs-fstab">
  <title>CephFS en <filename>/etc/fstab</filename></title>

  <para>
   Para montar CephFS automáticamente durante el inicio del cliente, inserte la línea correspondiente en la tabla de su sistema de archivos <filename>/etc/fstab</filename>:
  </para>

<screen>mon1:6790,mon2:/subdir /mnt/cephfs ceph name=admin,secretfile=/etc/ceph/secret.key,noatime,_netdev 0 2</screen>
 </sect1>
 <sect1 xml:id="ceph-cephfs-activeactive">
  <title>Varios daemons de servidor de metadatos activos (servidor de metadatos activo-activo)</title>

  <para>
   CephFS está configurado por defecto para un solo daemon de servidor de metadatos activo. Para ampliar el rendimiento de los metadatos en sistemas a gran escala, puede habilitar varios daemons de servidor de metadatos activos: compartirán la carga de trabajo de los metadatos entre sí.
  </para>

  <sect2>
   <title>Cuándo debe utilizarse un servidor de metadatos activo-activo</title>
   <para>
    Puede ser útil usar varios daemons de servidor de metadatos activos si el rendimiento de los metadatos sufre un cuello de botella en el servidor de metadatos único por defecto.
   </para>
   <para>
    Añadir más daemons no mejora el rendimiento de todos los tipos de cargas de trabajo. Por ejemplo, una única aplicación que se ejecute en un único cliente no se beneficiará de un número mayor de daemons de servidor de metadatos; a menos que la aplicación lleve a cabo muchas operaciones de metadatos en paralelo.
   </para>
   <para>
    Las cargas de trabajo que suelen beneficiarse de que haya un número mayor de daemons de servidor de metadatos activos son las que tienen muchos clientes, quizás funcionando en muchos directorios diferentes.
   </para>
  </sect2>

  <sect2 xml:id="cephfs-activeactive-increase">
   <title>Aumento del tamaño del clúster activo del servidor de metadatos</title>
   <para>
    Cada sistema de archivos CephFS tiene un valor <option>max_mds</option> que controla el número de rangos que se van a crear. El número real de rangos en el sistema de archivos solo aumentará si hay un daemon de repuesto disponible para hacerse cargo del nuevo rango. Por ejemplo, si hay solo un daemon de servidor de metadatos en ejecución y en <option>max_mds</option> se define el valor 2, no se creará un segundo rango.
   </para>
   <para>
    En el ejemplo siguiente, la opción <option>max_mds</option> se define con el valor 2 para crear un nuevo rango aparte del rango por defecto. Para ver los cambios, ejecute <command>ceph status</command> antes y, después de definir <option>max_mds</option>, observe la línea que contiene <literal>fsmap</literal>:
   </para>
<screen><prompt>root@master # </prompt><command>ceph</command> status
  [...]
  services:
    [...]
    mds: cephfs-1/1/1 up  {0=node2=up:active}, 1 up:standby
    [...]
<prompt>root@master # </prompt><command>ceph</command> mds set max_mds 2
<prompt>root@master # </prompt><command>ceph</command> status
  [...]
  services:
    [...]
    mds: cephfs-2/2/2 up  {0=node2=up:active,1=node1=up:active}
    [...]</screen>
   <para>
    El rango recién creado (1) pasa por el estado de "creación" y entra en su estado "activo".
   </para>
   <important>
    <title>daemons en espera</title>
    <para>
     Incluso con varios daemons de servidor de metadatos activos, un sistema de alta disponibilidad sigue necesitando daemons en espera para que entren en acción si falla alguno de los servidores en los que se ejecuta un daemon activo.
    </para>
    <para>
     En consecuencia, el número máximo práctico de <option>max_mds</option> para sistemas de alta disponibilidad es uno menos que el número total de servidores de metadatos del sistema. Para seguir estando disponible en caso de que varios servidores fallen, aumente el número de daemons en espera del sistema para que sea igual al número de servidores que se pueda admitir que fallen.
    </para>
   </important>
  </sect2>

  <sect2 xml:id="cephfs-activeactive-decrease">
   <title>Reducción del número de rangos</title>
   <para>
    Todos los rangos, incluidos los que se van a eliminar, deben estar activos en primer lugar. Esto significa que debe tener al menos el número de <option>max_mds</option> de daemons de servidor de metadatos disponibles.
   </para>
   <para>
    En primer lugar, defina en <option>max_mds</option> un número inferior. Por ejemplo, vuelva a tener un único servidor de metadatos activo:
   </para>
<screen><prompt>root@master # </prompt><command>ceph</command> status
  [...]
  services:
    [...]
    mds: cephfs-2/2/2 up  {0=node2=up:active,1=node1=up:active}
    [...]
<prompt>root@master # </prompt><command>ceph</command> mds set max_mds 1
<prompt>root@master # </prompt><command>ceph</command> status
  [...]
  services:
    [...]
    mds: cephfs-1/1/1 up  {0=node2=up:active}, 1 up:standby
    [...]</screen>
   <para>
    Fíjese en que sigue teniendo dos servidores de metadatos activos. Los rangos aún existen, aunque hemos reducido el número de <option>max_mds</option>, ya que <option>max_mds</option> solo restringe la creación de nuevos rangos.
   </para>
   <para>
    A continuación, use el comando <command>ceph mds deactivate <replaceable>rango</replaceable></command> para eliminar el rango que no se necesita:
   </para>
<screen><prompt>root@master # </prompt><command>ceph</command> status
  [...]
  services:
    [...]
    mds: cephfs-2/2/1 up  {0=node2=up:active,1=node1=up:active}
<prompt>root@master # </prompt><command>ceph</command> mds deactivate 1
telling mds.1:1 192.168.58.101:6805/2799214375 to deactivate

<prompt>root@master # </prompt><command>ceph</command> status
  [...]
  services:
    [...]
    mds: cephfs-2/2/1 up  {0=node2=up:active,1=node1=up:stopping}

<prompt>root@master # </prompt><command>ceph</command> status
  [...]
  services:
    [...]
    mds: cephfs-1/1/1 up  {0=node2=up:active}, 1 up:standby</screen>
   <para>
    El rango desactivado entrará primero en estado de detención durante el tiempo que tarda en entregar sus metadatos a los restantes daemons activos. Esta fase puede tardar entre unos segundos y varios minutos. Si parece que el servidor de metadatos se ha bloqueado en el estado de detención, investigue si existe algún error.
   </para>
   <para>
    Si un daemon de servidor de metadatos se bloquea o se interrumpe mientras se encuentra en estado de "detención", un daemon en espera ocupará su lugar y el rango volverá al estado "activo". Puede probar a desactivarlo de nuevo cuando se haya recuperado.
   </para>
   <para>
    Cuando el daemon termina la fase de detención, se inicia y vuelve a un estado de espera.
   </para>
  </sect2>

  <sect2 xml:id="cephfs-activeactive-pinning">
   <title>Fijación manual de árboles de directorio a un rango</title>
   <para>
    En las configuraciones con varios servidores de metadatos activos, se ejecuta un mecanismo de equilibrio que funciona para distribuir la carga de los metadatos de forma uniforme en el clúster. Esto suele ser suficientemente para la mayoría de los usuarios pero, en ocasiones, es aconsejable sustituir el mecanismo de equilibrio dinámico por asignaciones explícitas de metadatos para rangos concreto. De esta forma, se permite que el administrador o los usuarios puedan distribuir uniformemente la carga de la aplicación o limitar el impacto de las peticiones de metadatos de los usuarios en todo el clúster.
   </para>
   <para>
    El mecanismo proporcionado para este propósito se denomina "fijación de exportación". Se trata de un atributo extendido de los directorios. El nombre de este atributo extendido es <literal>ceph.dir.pin</literal>. Los usuarios pueden definir este atributo mediante comandos estándar:
   </para>
<screen>setfattr -n ceph.dir.pin -v 2 <replaceable>/path/to/dir</replaceable></screen>
   <para>
    El valor (<option>- v</option>) del atributo extendido es el rango al que se debe asignar el subárbol de directorio. Un valor por defecto de -1 indica que el directorio no está fijado.
   </para>
   <para>
    La fijación de exportación de directorio se hereda de su padre más próximo que cuente con una fijación de exportación definido. Por lo tanto, definir la fijación de exportación en un directorio, afecta a todos sus hijos. Sin embargo, la fijación padre se puede sustituir definiendo fijaciones de exportación en el directorio hijo. Por ejemplo:
   </para>
<screen>mkdir -p a/b                      # "a" and "a/b" start with no export pin set.
setfattr -n ceph.dir.pin -v 1 a/  # "a" and "b" are now pinned to rank 1.
setfattr -n ceph.dir.pin -v 0 a/b # "a/b" is now pinned to rank 0
                                  # and "a/" and the rest of its children
                                  # are still pinned to rank 1.</screen>
  </sect2>
 </sect1>
 <sect1 xml:id="ceph-cephfs-failover">
  <title>Gestión del failover</title>

  <para>
   Si un daemon de servidor de metadatos deja de comunicarse con el monitor, este espera el número de segundos definido en <option>mds_beacon_grace</option> (por defecto, 15 segundos) antes de marcar el daemon como <emphasis>retrasado</emphasis>. Es posible configurar uno o varios daemons en espera que se harán cargo del trabajo durante un failover del daemon de servidor de metadatos.
  </para>

  <sect2 xml:id="ceph-cephfs-failover-standby">
   <title>Configuración de daemons en espera</title>
   <para>
    Existen varios valores de configuración que controlan el comportamiento de un daemon en espera. Puede especificarlos en el archivo <filename>ceph.conf</filename> del host donde se ejecuta el daemon de servidor de metadatos. El daemon carga estos valores cuando se inicia y los envía al monitor.
   </para>
   <para>
    Por defecto, si no se usa ninguno de estos valores, todos los daemons de servidor de metadatos que no tengan un rango se utilizarán como daemons en espera para cualquier rango.
   </para>
   <para>
    Los valores que asocian un daemon en espera con un nombre o rango en concreto no garantizan que el daemon solo se use para ese rango. Esto significa que si hay varios daemons en espera disponibles, se utilizará el daemon en espera asociado. Si un rango falla y hay un daemon en espera disponible, se utilizará aunque esté asociado a un rango o un nombre distinto.
   </para>
   <variablelist>
    <varlistentry>
     <term>mds_standby_replay</term>
     <listitem>
      <para>
       Si se define como verdadero, el daemon en espera leerá de forma continua el diario de metadatos de un rango superior. De esta forma, su caché de metadatos estará listo y se acelera el proceso de recuperación tras fallo si el daemon que presta servicios al rango falla.
      </para>
      <para>
       Un rango superior solo puede tener un daemon de respuesta en espera asignado. Si se definen dos daemons para que sean daemons de respuesta en espera, uno de ellos se asignará de forma arbitraria y el otro se convertirá en un daemon no de respuesta en espera normal.
      </para>
      <para>
       Si un daemon ha entrado en estado de respuesta en espera, solo se utilizará como daemon en espera para el rango al que sigue. Si otro rango falla, este daemon de respuesta en espera no se utilizará como sustituto, aunque no haya ningún otro daemon en espera disponible.
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>mds_standby_for_name</term>
     <listitem>
      <para>
       Defina esta opción para que el daemon en espera solo asuma el puesto de un rango que ha fallado si el último daemon que lo aloja coincide con este nombre.
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>mds_standby_for_rank</term>
     <listitem>
      <para>
       Defina esta opción para que el daemon en espera solo asuma el puesto del rango especificado. Si falla otro rango, este daemon no se utilizará para sustituirlo.
      </para>
      <para>
       Úselo junto con <option>mds_standby_for_fscid</option> para especificar claramente a qué rango del sistema de archivos se debe dirigir en caso de que haya varios sistemas de archivos.
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>mds_standby_for_fscid</term>
     <listitem>
      <para>
       Si <option>mds_standby_for_rank</option> está definido, se trata simplemente de un calificador para indicar a qué rango del sistema de archivos se hace referencia.
      </para>
      <para>
       Si <option>mds_standby_for_rank</option> no está definido, el valor FSCID provocará que este daemon se dirija a cualquier rango del FSCID especificado. Utilice esta opción si tiene un daemon que desea utilizar para cualquier rango, pero solo en un sistema de archivos concreto.
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>mon_force_standby_active</term>
     <listitem>
      <para>
       Este valor se utiliza en los hosts de monitor. Por defecto, su valor es true (verdadero).
      </para>
      <para>
       Si es false (falso), los daemons configurados con <option>standby_replay=true</option> solo se convertirán en activos si falla el rango o el nombre que tienen configurado para seguir. Por otro lado, si el valor es true (verdadero), un daemon configurado con <option>standby_replay=true</option> se puede asignar a otro rango.
      </para>
     </listitem>
    </varlistentry>
   </variablelist>
  </sect2>

  <sect2 xml:id="ceph-cephfs-failover-examples">
   <title>Ejemplos</title>
   <para>
    A continuación se muestran varios ejemplos de configuraciones de <filename>ceph.conf</filename>. Puede copiar un <filename>ceph.conf</filename> con la configuración de todos los daemons en todos los servidores, o bien puede tener un archivo diferente en cada servidor que contenga la configuración del daemon de dicho servidor.
   </para>
   <sect3>
    <title>Par simple</title>
    <para>
     Hay dos daemons de servidor de metadatos "a" y "b" que actúan como un par. Si alguno de ellos no se ha asignado a un rango, será el seguidor de respuesta en espera del otro.
    </para>
<screen>[mds.a]
mds standby replay = true
mds standby for rank = 0

[mds.b]
mds standby replay = true
mds standby for rank = 0</screen>
   </sect3>

  </sect2>
 </sect1>
</chapter>
