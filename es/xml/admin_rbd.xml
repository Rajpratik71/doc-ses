<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="admin_rbd.xml" version="5.0" xml:id="ceph-rbd">
 <title>Dispositivo de bloques RADOS</title>
 <info>
      <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
        <dm:translation>sí</dm:translation>
        <dm:release>SES 5</dm:release>
      </dm:docmanager>
    </info>
    <para>
  Un bloque es una secuencia de bytes, por ejemplo, un bloque de 512 bytes de datos. Las interfaces de almacenamiento basadas en bloques son la forma más habitual de almacenar los datos en soportes de uso rotativo, como discos duros, CD o disquetes. La ubicuidad de las interfaces de dispositivos de bloques hacen que un dispositivo de bloques virtual sea el candidato idóneo para interactuar con un sistema de almacenamiento masivo de datos como Ceph.
 </para>
 <para>
  Los dispositivos de bloques de Ceph permiten compartir recursos físicos y se puede modificar su tamaño. Los datos se almacenan repartidos en varios OSD en un clúster de Ceph. Los dispositivos de bloques de Ceph aprovechan las funciones de RADOS, como la realización de instantáneas, las réplicas y la comprobación de coherencia. Los dispositivos de bloques RADOS (RBD) de Ceph interactúan con los OSD mediante módulos del kernel o la biblioteca <systemitem>librbd</systemitem>.
 </para>
 <figure>
  <title>Protocolo RADOS</title>
  <mediaobject>
   <imageobject role="fo">
    <imagedata fileref="ceph_rbd_schema.png" width="70%" format="PNG"/>
   </imageobject>
   <imageobject role="html">
    <imagedata fileref="ceph_rbd_schema.png" width="70%" format="PNG"/>
   </imageobject>
  </mediaobject>
 </figure>
 <para>
  Los dispositivos de bloques de Ceph ofrecen un alto rendimiento con infinitas posibilidades de escalabilidad para los módulos de kernel. Son compatibles con soluciones de virtualización como QEMU o sistemas informáticos basados en la nube que dependen de <systemitem class="library">libvirt</systemitem>, como OpenStack. Puede utilizar el mismo clúster para gestionar Object Gateway, CephFS y los dispositivos de bloques RADOS al mismo tiempo.
 </para>
 <sect1 xml:id="ceph-rbd-commands">
  <title>Comandos del dispositivo de bloques</title>

  <para>
   El comando <command>rbd</command> permite crear, enumerar, examinar y eliminar imágenes de los dispositivos de bloques. También se puede emplear, por ejemplo, para clonar imágenes, crear instantáneas, revertir una imagen al estado de una instantánea o ver una instantánea.
  </para>

  <tip>
   <title>acceso a un clúster</title>
   <para>
    Para utilizar los comandos del dispositivo de bloque RADOS, debe tener acceso a un clúster de Ceph en ejecución.
   </para>
  </tip>

  <sect2 xml:id="ceph-rbd-cmds-create">
   <title>Creación de una imagen del dispositivo de bloques</title>
   <para>
    Para poder añadir un dispositivo de bloques a un nodo, primero debe crear una imagen para él en el clúster. Para crear la imagen de un dispositivo de bloques, ejecute lo siguiente:
   </para>
<screen><prompt>root # </prompt>rbd create --size <replaceable>megabytes</replaceable> <replaceable>pool-name</replaceable>/<replaceable>image-name</replaceable></screen>
   <para>
    Por ejemplo, para crear una imagen de 1 GB denominada "bar" que almacena información en un repositorio llamado "swimmingpool", ejecute lo siguiente:
   </para>
<screen><prompt>root # </prompt>rbd create --size 1024 swimmingpool/bar</screen>
   <tip>
    <title>repositorio por defecto</title>
    <para>
     Si no especifica un repositorio al crear una imagen, se almacenará en el repositorio por defecto, "rbd".
    </para>
   </tip>
   <note>
    <title>primero debe crear el repositorio</title>
    <para>
     Debe crear un repositorio antes de especificarlo como origen. Consulte el <xref linkend="ceph-pools"/> para obtener más información.
    </para>
   </note>
  </sect2>

  <sect2 xml:id="ceph-rbd-cmds-create-ec">
   <title>Creación de una imagen del dispositivo de bloques en un repositorio codificado de borrado</title>
   <para>
    A partir de SUSE Enterprise Storage 5, es posible almacenar datos de una imagen de dispositivo de bloques en repositorios codificados de borrado. Solo la parte de "datos" de una imagen RBD se puede almacenar en un repositorio codificado de borrado. Además, el repositorio codificado de borrado debe tener el indicador "overwrite" (sobrescribir) definido como <emphasis>true</emphasis>. Este indicador solo se puede definir como <emphasis>true</emphasis> si todos los OSD utilizan BlueStore.
   </para>
   <para>
    Los metadatos de la imagen no pueden residir en un repositorio codificado de borrado. Los metadatos pueden residir en el repositorio "rbd" por defecto o en el repositorio que el usuario especifique explícitamente con el parámetro <parameter>--pool=</parameter> en el comando <command>rbd create</command>.
   </para>
   <note>
    <title>BlueStore es necesario</title>
    <para>
     Todos los nodos requieren BlueStore para utilizar los repositorios codificados de borrado para las imágenes de dispositivos de bloques.
    </para>
   </note>
   <para>
    Lleve a cabo los pasos siguientes para crear una imagen RBD en un repositorio codificado de borrado:
   </para>
<screen><prompt>root # </prompt><command>ceph</command> osd pool create <replaceable>POOL_NAME</replaceable> 12 12 erasure
<prompt>root # </prompt><command>ceph</command> osd pool set <replaceable>POOL_NAME</replaceable> allow_ec_overwrites true

# Metadata will reside in pool "rbd", and data in pool "<replaceable>POOL_NAME</replaceable>"
<prompt>root # </prompt><command>rbd</command> create <replaceable>IMAGE_NAME</replaceable> --size=1G --data-pool <replaceable>POOL_NAME</replaceable>

#Metadata will reside in pool "<replaceable>OTHER_POOL</replaceable>", and data in pool "<replaceable>POOL_NAME</replaceable>"
<prompt>root # </prompt><command>rbd</command> create <replaceable>IMAGE_NAME</replaceable> --size=1G --data-pool <replaceable>POOL_NAME</replaceable> --pool=<replaceable>OTHER_POOL</replaceable></screen>
  </sect2>

  <sect2 xml:id="ceph-rbd-cmds-list">
   <title>Enumeración de imágenes de dispositivos de bloques</title>
   <para>
    Para enumerar los dispositivos de bloques en el repositorio "rbd", ejecute lo siguiente ("rbd" es el nombre del repositorio por defecto):
   </para>
<screen><prompt>root # </prompt>rbd ls</screen>
   <para>
    Para enumerar los dispositivos de bloques en un repositorio llamado "swimmingpool", ejecute lo siguiente:
   </para>
<screen><prompt>root # </prompt>rbd ls swimmingpool</screen>
  </sect2>

  <sect2 xml:id="ceph-rbd-cmds-info">
   <title>Recuperación de información de la imagen</title>
   <para>
    Para recuperar información de una imagen llamada "bar" dentro de un repositorio denominado "swimmingpool", ejecute lo siguiente:
   </para>
<screen><prompt>root # </prompt>rbd info swimmingpool/bar</screen>
  </sect2>

  <sect2 xml:id="ceph-rbd-cmds-resize">
   <title>Cambio de tamaño de la imagen de un dispositivo de bloques</title>
   <para>
    Las imágenes de los dispositivos de bloques RADOS emplean un sistema de provisión ligera, lo que significa que no emplean espacio físico real hasta que empieza a guardar datos en ellos. No obstante, tienen una capacidad máxima que se define mediante la opción <option>--size</option>. Si desea aumentar (o reducir) el tamaño máximo de la imagen (o disminuir), ejecute lo siguiente:
   </para>
<screen><prompt>root # </prompt>rbd resize --size 2048 foo # to increase
rbd resize --size 2048 foo --allow-shrink # to decrease</screen>
  </sect2>

  <sect2 xml:id="ceph-rbd-cmds-rm">
   <title>Eliminación de una imagen de dispositivo de bloques</title>
   <para>
    Para eliminar un dispositivo de bloques que se corresponde con una imagen llamada "bar" en un repositorio denominado "swimmingpool", ejecute lo siguiente:
   </para>
<screen><prompt>root # </prompt>rbd rm swimmingpool/bar</screen>
  </sect2>
 </sect1>
 <sect1 xml:id="storage-bp-integration-mount-rbd">
  <title>Montaje y desmontaje de imágenes RBD</title>

  <para>
   Después de crear un dispositivo de bloques RADOS, puede formatearlo, montarlo para que permita el intercambio de archivos y desmontarlo cuando haya terminado.
  </para>

  <procedure>
   <step>
    <para>
     Asegúrese de que el clúster de Ceph incluye un repositorio con la imagen de disco que desea montar. Supongamos que el repositorio se denomina <literal>mypool</literal> y la imagen <literal>myimage</literal>.
    </para>
<screen>rbd list mypool</screen>
   </step>
   <step>
    <para>
     Asigne la imagen a un nuevo dispositivo de bloques.
    </para>
<screen><prompt>root # </prompt>rbd map --pool mypool myimage</screen>
    <tip>
     <title>nombre de usuario y autenticación</title>
     <para>
      Para especificar un nombre de usuario, utilice <option>--id <replaceable>nombre de usuario</replaceable></option>. Además, si utiliza la autenticación <systemitem>cephx</systemitem>, también debe especificar un secreto. Puede proceder de un anillo de claves o de un archivo que contenga el secreto:
     </para>
<screen><prompt>root # </prompt>rbd map --pool rbd myimage --id admin --keyring /path/to/keyring</screen>
     <para>
      O bien
     </para>
<screen><prompt>root # </prompt>rbd map --pool rbd myimage --id admin --keyfile /path/to/file</screen>
    </tip>
   </step>
   <step>
    <para>
     Enumerar todos los dispositivos asignados:
    </para>
<screen><prompt>root # </prompt>rbd showmapped
 id pool   image   snap device
 0  mypool myimage -    /dev/rbd0</screen>
    <para>
     El dispositivo en el que queremos trabajar es <filename>/dev/rbd0</filename>.
    </para>
   </step>
   <step>
    <para>
     Cree un sistema de archivos XFS en el dispositivo <filename>/dev/rbd0</filename>.
    </para>
<screen><prompt>root # </prompt>mkfs.xfs /dev/rbd0
 log stripe unit (4194304 bytes) is too large (maximum is 256KiB)
 log stripe unit adjusted to 32KiB
 meta-data=/dev/rbd0              isize=256    agcount=9, agsize=261120 blks
          =                       sectsz=512   attr=2, projid32bit=1
          =                       crc=0        finobt=0
 data     =                       bsize=4096   blocks=2097152, imaxpct=25
          =                       sunit=1024   swidth=1024 blks
 naming   =version 2              bsize=4096   ascii-ci=0 ftype=0
 log      =internal log           bsize=4096   blocks=2560, version=2
          =                       sectsz=512   sunit=8 blks, lazy-count=1
 realtime =none                   extsz=4096   blocks=0, rtextents=0</screen>
   </step>
   <step>
    <para>
     Monte el dispositivo y compruebe que está montado correctamente. Sustituya <filename>/mnt</filename> por el punto de montaje.
    </para>
<screen><prompt>root # </prompt>mount /dev/rbd0 /mnt
<prompt>root # </prompt>mount | grep rbd0
/dev/rbd0 on /mnt type xfs (rw,relatime,attr2,inode64,sunit=8192,...</screen>
    <para>
     Ya puede mover datos al dispositivo y desde él como si fuese un directorio local.
    </para>
    <tip>
     <title>aumento del tamaño del dispositivo RBD</title>
     <para>
      Si descubre que el tamaño del dispositivo RBD es insuficiente, puede aumentarlo con facilidad.
     </para>
     <orderedlist spacing="normal">
      <listitem>
       <para>
        Aumente el tamaño de la imagen RBD, por ejemplo, hasta 10 GB.
       </para>
<screen><prompt>root # </prompt>rbd resize --size 10000 mypool/myimage
 Resizing image: 100% complete...done.</screen>
      </listitem>
      <listitem>
       <para>
        Aumente el sistema de archivos hasta llenar el nuevo tamaño del dispositivo.
       </para>
<screen><prompt>root # </prompt>xfs_growfs /mnt
 [...]
 data blocks changed from 2097152 to 2560000</screen>
      </listitem>
     </orderedlist>
    </tip>
   </step>
   <step>
    <para>
     Cuando termine de acceder al dispositivo, puede desmontarlo.
    </para>
<screen><prompt>root # </prompt>unmount /mnt</screen>
   </step>
  </procedure>

  <tip>
   <title>montaje o desmontaje manual</title>
   <para>
    Dado que asignar y montar las imágenes RBD manualmente después del arranque y desmontarlas y desasignarlas antes de apagar el equipo puede resultar tedioso, se proporciona un guion <command>rbdmap</command> y una unidad <systemitem class="daemon">systemd</systemitem>. Consulte la <xref linkend="ceph-rbd-rbdmap"/>.
   </para>
  </tip>
 </sect1>
 <sect1 xml:id="cha-ceph-snapshots-rbd">
  <title>Instantáneas de dispositivos de bloques</title>

  <para>
   Una instantánea RBD es una instantánea de una imagen de dispositivo de bloques RADOS. Las instantáneas permiten conservar un historial de los estados de la imagen. Ceph también es compatible con capas de instantáneas, lo que permite clonar imágenes de máquinas virtuales de forma rápida y sencilla. Ceph admite las instantáneas de dispositivos de bloques mediante el comando <command>rbd</command> y muchas interfaces de alto nivel, incluidas QEMU, <systemitem>libvirt</systemitem>, OpenStack y CloudStack.
  </para>

  <note>
   <para>
    Detenga las operaciones de entrada y salida antes de realizar una instantánea de una imagen. Si la imagen contiene un sistema de archivos, el sistema de archivos debe tener un estado coherente <emphasis>antes</emphasis> de realizar la instantánea.
   </para>
  </note>

  <sect2>
   <title>Notas de cephx</title>
   <para>
    Si <systemitem>cephx</systemitem> está habilitado (consulte <link xlink:href="http://ceph.com/docs/master/rados/configuration/auth-config-ref/"/> para obtener más información), debe especificar un nombre de usuario o ID y una vía al anillo de claves que contiene la clave correspondiente para el usuario. Consulte <link xlink:href="http://ceph.com/docs/master/rados/operations/user-management/">User Management</link> (Gestión de usuarios) para obtener más información. También puede añadir la variable de entorno <systemitem>CEPH_ARGS</systemitem> para evitar la reintroducción de los siguientes parámetros.
   </para>
<screen><prompt>root # </prompt>rbd --id <replaceable>user-ID</replaceable> --keyring=/path/to/secret <replaceable>commands</replaceable>
<prompt>root # </prompt>rbd --name <replaceable>username</replaceable> --keyring=/path/to/secret <replaceable>commands</replaceable></screen>
   <para>
    Por ejemplo:
   </para>
<screen><prompt>root # </prompt>rbd --id admin --keyring=/etc/ceph/ceph.keyring <replaceable>commands</replaceable>
<prompt>root # </prompt>rbd --name client.admin --keyring=/etc/ceph/ceph.keyring <replaceable>commands</replaceable></screen>
   <tip>
    <para>
     Añada el usuario y el secreto a la variable de entorno <systemitem>CEPH_ARGS</systemitem> para no tener que introducir estos datos en cada ocasión.
    </para>
   </tip>
  </sect2>

  <sect2>
   <title>Conceptos básicos de la instantánea</title>
   <para>
    Los procedimientos siguientes muestran cómo crear, enumerar y eliminar instantáneas mediante el comando <command>rbd</command> en la línea de comandos.
   </para>
   <sect3>
    <title>Creación de instantáneas</title>
    <para>
     Para crear una instantánea con <command>rbd</command>, especifique la opción <option>snap create</option>, el nombre del repositorio y el nombre de la imagen.
    </para>
<screen><prompt>root # </prompt>rbd --pool <replaceable>pool-name</replaceable> snap create --snap <replaceable>snap-name</replaceable> <replaceable>image-name</replaceable>
<prompt>root # </prompt>rbd snap create <replaceable>pool-name</replaceable>/<replaceable>image-name</replaceable>@<replaceable>snap-name</replaceable></screen>
    <para>
     Por ejemplo:
    </para>
<screen><prompt>root # </prompt>rbd --pool rbd snap create --snap snapshot1 image1
<prompt>root # </prompt>rbd snap create rbd/image1@snapshot1</screen>
   </sect3>
   <sect3>
    <title>Enumeración de instantáneas</title>
    <para>
     Para enumerar las instantáneas de una imagen, especifique el nombre del repositorio y el de la imagen.
    </para>
<screen><prompt>root # </prompt>rbd --pool <replaceable>pool-name</replaceable> snap ls <replaceable>image-name</replaceable>
<prompt>root # </prompt>rbd snap ls <replaceable>pool-name</replaceable>/<replaceable>image-name</replaceable></screen>
    <para>
     Por ejemplo:
    </para>
<screen><prompt>root # </prompt>rbd --pool rbd snap ls image1
<prompt>root # </prompt>rbd snap ls rbd/image1</screen>
   </sect3>
   <sect3>
    <title>Reversión de instantáneas</title>
    <para>
     Para revertir una instantánea con <command>rbd</command>, especifique la opción <option>snap rollback</option>, el nombre del repositorio, el nombre de la imagen y el nombre de la instantánea.
    </para>
<screen><prompt>root # </prompt>rbd --pool <replaceable>pool-name</replaceable> snap rollback --snap <replaceable>snap-name</replaceable> <replaceable>image-name</replaceable>
<prompt>root # </prompt>rbd snap rollback <replaceable>pool-name</replaceable>/<replaceable>image-name</replaceable>@<replaceable>snap-name</replaceable></screen>
    <para>
     Por ejemplo:
    </para>
<screen><prompt>root # </prompt>rbd --pool pool1 snap rollback --snap snapshot1 image1
<prompt>root # </prompt>rbd snap rollback pool1/image1@snapshot1</screen>
    <note>
     <para>
      Revertir una imagen a una instantánea significa sobrescribir la versión actual de la imagen con los datos de la instantánea. El tiempo necesario para ejecutar una reversión aumenta según el tamaño de la imagen. Es más rápido <emphasis>clonar</emphasis> una instantánea que <emphasis>revertir</emphasis> una imagen a una instantánea, por lo que es el método preferible para volver a un estado preexistente.
     </para>
    </note>
   </sect3>
   <sect3>
    <title>Supresión de una instantánea</title>
    <para>
     Para suprimir una instantánea con <command>rbd</command>, especifique la opción <option>snap rm</option>, el nombre del repositorio, el nombre de la imagen y el nombre de usuario.
    </para>
<screen><prompt>root # </prompt>rbd --pool <replaceable>pool-name</replaceable> snap rm --snap <replaceable>snap-name</replaceable> <replaceable>image-name</replaceable>
<prompt>root # </prompt>rbd snap rm <replaceable>pool-name</replaceable>/<replaceable>image-name</replaceable>@<replaceable>snap-name</replaceable></screen>
    <para>
     Por ejemplo:
    </para>
<screen><prompt>root # </prompt>rbd --pool pool1 snap rm --snap snapshot1 image1
<prompt>root # </prompt>rbd snap rm pool1/image1@snapshot1</screen>
    <note>
     <para>
      Los OSD de Ceph suprimen los datos de forma asíncrona, por lo que al suprimir una instantánea, no se libera el espacio de disco inmediatamente.
     </para>
    </note>
   </sect3>
   <sect3>
    <title>Limpieza de instantáneas</title>
    <para>
     Para suprimir todas las instantáneas de una imagen con <command>rbd</command>, especifique la opción <option>snap purge</option> y el nombre de la imagen.
    </para>
<screen><prompt>root # </prompt>rbd --pool <replaceable>pool-name</replaceable> snap purge <replaceable>image-name</replaceable>
<prompt>root # </prompt>rbd snap purge <replaceable>pool-name</replaceable>/<replaceable>image-name</replaceable></screen>
    <para>
     Por ejemplo:
    </para>
<screen><prompt>root # </prompt>rbd --pool pool1 snap purge image1
<prompt>root # </prompt>rbd snap purge pool1/image1</screen>
   </sect3>
  </sect2>

  <sect2 xml:id="ceph-snapshoti-layering">
   <title>Capas</title>
   <para>
    Ceph admite la posibilidad de crear muchos clones de copia de escritura (COW, por sus siglas en inglés) de una instantánea de dispositivo de bloques. Las capas de instantáneas permiten que los clientes de dispositivos de bloques de Ceph creen imágenes muy rápidamente. Por ejemplo, puede crear una imagen de dispositivo de bloques con una máquina virtual Linux escrita en él y, a continuación, realizar una instantánea de la imagen, protegerla y crear tantos clones de copia de escritura como desee. Las instantáneas son de solo lectura, por lo que clonar una instantánea simplifica la semántica y permite crear clones rápidamente.
   </para>
   <note>
    <para>
     Los términos "parent" (padre) y "child" (hijo) mencionados en los siguientes ejemplos de la línea de comandos hacen referencia a una instantánea de un dispositivo de bloques de Ceph (padre) y la imagen correspondiente clonada de la instantánea (hijo).
    </para>
   </note>
   <para>
    Cada imagen clonada (hijo) almacena una referencia a su imagen padre que permite que la imagen clonada abra la instantánea padre y la lea.
   </para>
   <para>
    Un clon COW de una instantánea se comporta exactamente igual que cualquier otra imagen de dispositivo de bloques de Ceph. Puede leer las imágenes clonadas, escribir en ellas, clonarlas y redimensionarlas. No existen restricciones especiales que afecten a las imágenes clonadas. No obstante, la clonación de copia de escritura de una instantánea hace referencia a la instantánea, por lo que <emphasis>debe</emphasis> proteger la instantánea antes de clonarla.
   </para>
   <note>
    <para>
     Ceph solo es compatible con la clonación de imágenes de <emphasis>formato 2</emphasis> (creadas con <command>rbd create --image-format 2</command>).
    </para>
   </note>
   <sect3>
    <title>Procedimientos iniciales con las capas</title>
    <para>
     La aplicación de capas a un dispositivo de bloques de Ceph es un proceso sencillo. Debe disponer de una imagen. Debe crear una instantánea de la imagen. Debe proteger la instantánea. Una vez realizados estos pasos, puede empezar a clonar la instantánea.
    </para>
    <para>
     La imagen clonada tendrá una referencia a la instantánea padre e incluirá el ID del repositorio, el ID de la imagen y el ID de la instantánea. La inclusión del ID del repositorio significa que se pueden clonar instantáneas de un repositorio como imágenes en un repositorio distinto.
    </para>
    <itemizedlist mark="bullet" spacing="normal">
     <listitem>
      <para>
       <emphasis>Plantilla de imagen:</emphasis> un ejemplo de uso habitual para crear capas de dispositivos de bloques es crear una imagen principal y una instantánea que sirva como plantilla para los clones. Por ejemplo, un usuario puede crear una imagen de una distribución de Linux (como SUSE Linux Enterprise Server) y crear una instantánea para ella. El usuario puede actualizar periódicamente la imagen y crear una instantánea nueva (por ejemplo, <command>zypper ref &amp;&amp; zypper patch</command>, seguido de <command>rbd snap create</command>). A medida que la imagen crezca, el usuario puede clonar cualquiera de las instantáneas.
      </para>
     </listitem>
     <listitem>
      <para>
       <emphasis>Plantilla extendida:</emphasis> un ejemplo de uso más avanzado implica la posibilidad de extender una imagen de plantilla para que proporcione más información que una imagen base. Por ejemplo, un usuario puede clonar una imagen (una plantilla de máquina virtual) e instalar otro software (por ejemplo, una base de datos, un sistema de gestión de contenido o un sistema de análisis) y, a continuación, realizar una instantánea de la imagen extendida, que a su vez se puede actualizar de la misma manera que la imagen base.
      </para>
     </listitem>
     <listitem>
      <para>
       <emphasis>Repositorio de plantillas:</emphasis> una manera de utilizar capas de dispositivos de bloques es crear un repositorio que contenga imágenes principales que actúen como plantillas e instantáneas de dichas plantillas. A continuación, puede ampliar los privilegios de solo lectura a los usuarios, de modo que tengan la posibilidad de clonar las instantáneas sin la capacidad de escribir o ejecutar dentro del repositorio.
      </para>
     </listitem>
     <listitem>
      <para>
       <emphasis>Migración y recuperación de imágenes:</emphasis> una manera de utilizar capas de dispositivos de bloques consiste en migrar o recuperar datos de un repositorio a otro.
      </para>
     </listitem>
    </itemizedlist>
   </sect3>
   <sect3>
    <title>Protección de una instantánea</title>
    <para>
     Los clones acceden a las instantáneas padre. Todos los clones dejarán de funcionar si un usuario suprime por error la instantánea padre. Para evitar la pérdida de datos, debe proteger la instantánea antes de clonarla.
    </para>
<screen><prompt>root # </prompt>rbd --pool <replaceable>pool-name</replaceable> snap protect \
 --image <replaceable>image-name</replaceable> --snap <replaceable>snapshot-name</replaceable>
<prompt>root # </prompt>rbd snap protect <replaceable>pool-name</replaceable>/<replaceable>image-name</replaceable>@<replaceable>snapshot-name</replaceable></screen>
    <para>
     Por ejemplo:
    </para>
<screen><prompt>root # </prompt>rbd --pool pool1 snap protect --image image1 --snap snapshot1
<prompt>root # </prompt>rbd snap protect pool1/image1@snapshot1</screen>
    <note>
     <para>
      No es posible suprimir una instantánea protegida.
     </para>
    </note>
   </sect3>
   <sect3>
    <title>Clonación de una instantánea</title>
    <para>
     Para clonar una instantánea, debe especificar el repositorio padre, la imagen, la instantánea, el repositorio hijo y el nombre de la imagen. Debe proteger la instantánea para poder clonarla.
    </para>
<screen><prompt>root # </prompt>rbd --pool <replaceable>pool-name</replaceable> --image <replaceable>parent-image</replaceable> \
 --snap <replaceable>snap-name</replaceable> --dest-pool <replaceable>pool-name</replaceable> \
 --dest <replaceable>child-image</replaceable>
<prompt>root # </prompt>rbd clone <replaceable>pool-name</replaceable>/<replaceable>parent-image</replaceable>@<replaceable>snap-name</replaceable> \
<replaceable>pool-name</replaceable>/<replaceable>child-image-name</replaceable></screen>
    <para>
     Por ejemplo:
    </para>
<screen><prompt>root # </prompt>rbd clone pool1/image1@snapshot1 pool1/image2</screen>
    <note>
     <para>
      Puede clonar una instantánea de un repositorio como una imagen de otro repositorio. Por ejemplo, puede mantener imágenes e instantáneas de solo lectura como plantillas en un repositorio y clones con acceso de escritura en otro.
     </para>
    </note>
   </sect3>
   <sect3>
    <title>Desprotección de una instantánea</title>
    <para>
     Para suprimir una instantánea, primero debe desprotegerla. Además, <emphasis>no puede</emphasis> suprimir instantáneas que tengan referencias de clones. Debe aplanar todos los clones de una instantánea para poder eliminarla.
    </para>
<screen><prompt>root # </prompt>rbd --pool <replaceable>pool-name</replaceable> snap unprotect --image <replaceable>image-name</replaceable> \
 --snap <replaceable>snapshot-name</replaceable>
<prompt>root # </prompt>rbd snap unprotect <replaceable>pool-name</replaceable>/<replaceable>image-name</replaceable>@<replaceable>snapshot-name</replaceable></screen>
    <para>
     Por ejemplo:
    </para>
<screen><prompt>root # </prompt>rbd --pool pool1 snap unprotect --image image1 --snap snapshot1
<prompt>root # </prompt>rbd snap unprotect pool1/image1@snapshot1</screen>
   </sect3>
   <sect3>
    <title>Enumeración de los hijos de una instantánea</title>
    <para>
     Para enumerar los hijos de una instantánea, ejecute lo siguiente:
    </para>
<screen><prompt>root # </prompt>rbd --pool <replaceable>pool-name</replaceable> children --image <replaceable>image-name</replaceable> --snap <replaceable>snap-name</replaceable>
<prompt>root # </prompt>rbd children <replaceable>pool-name</replaceable>/<replaceable>image-name</replaceable>@<replaceable>snapshot-name</replaceable></screen>
    <para>
     Por ejemplo:
    </para>
<screen><prompt>root # </prompt>rbd --pool pool1 children --image image1 --snap snapshot1
<prompt>root # </prompt>rbd children pool1/image1@snapshot1</screen>
   </sect3>
   <sect3>
    <title>Aplanamiento de una imagen clonada</title>
    <para>
     Las imágenes clonadas retienen una referencia a la instantánea padre. Si elimina la referencia del clon a la instantánea padre, la imagen se "aplana" copiando la información de la instantánea en el clon. El tiempo que se tarda en aplanar un clon aumenta según el tamaño de la instantánea. Para suprimir una instantánea, primero debe aplanar las imágenes hijo.
    </para>
<screen><prompt>root # </prompt>rbd --pool <replaceable>pool-name</replaceable> flatten --image <replaceable>image-name</replaceable>
<prompt>root # </prompt>rbd flatten <replaceable>pool-name</replaceable>/<replaceable>image-name</replaceable></screen>
    <para>
     Por ejemplo:
    </para>
<screen><prompt>root # </prompt>rbd --pool pool1 flatten --image image1
<prompt>root # </prompt>rbd flatten pool1/image1</screen>
    <note>
     <para>
      Dado que una imagen plana contiene toda la información de la instantánea, ocupará más espacio de almacenamiento que un clon con capas.
     </para>
    </note>
   </sect3>
  </sect2>
 </sect1>
 <sect1 xml:id="ceph-rbd-rbdmap">
  <title>rbdmap: asignación de dispositivos RBD durante el arranque</title>

  <para>
   <command>rbdmap</command> es un guion de shell que automatiza las operaciones <command>rbd map</command> y <command>rbd unmap</command> en una o varias imágenes de dispositivos de bloques RADOS. Aunque es posible ejecutar el guion manualmente en cualquier momento, el uso principal consiste en asignar y montar automáticamente las imágenes RBD durante el arranque (y desmontarlas y desasignarlas al apagar el equipo), activándose mediante el sistema Init. Con este fin, el paquete <systemitem>ceph-common</systemitem> incluye el archivo de unidad <systemitem class="daemon">systemd</systemitem> <filename>rbdmap.service</filename>.
  </para>

  <para>
   El guion solo acepta un argumento, que puede ser <option>map</option> o <option>unmap</option>. En ambos casos, el guion analiza un archivo de configuración. Se utiliza <filename>/etc/ceph/rbdmap</filename> por defecto, pero se puede anular mediante una variable de entorno <literal>RBDMAPFILE</literal>. Cada línea del archivo de configuración se corresponde con una imagen RBD que se debe asignar o desasignar.
  </para>

  <para>
   El archivo de configuración tiene el formato siguiente:
  </para>

<screen>image_specification rbd_options</screen>

  <variablelist>
   <varlistentry>
    <term>image_specification</term>
    <listitem>
     <para>
      Vía a una imagen dentro de un repositorio. Se debe especificar como <replaceable>nombre_repositorio</replaceable>/<replaceable>nombre_imagen</replaceable>. Si omite <replaceable>nombre_repositorio</replaceable>, se asume por defecto "rbd".
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>rbd_options</term>
    <listitem>
     <para>
      Una lista opcional de parámetros que se puedan pasar al comando <command>rbd map</command> subyacente. Estos parámetros y sus valores se deben especificar como una cadena separada por comas, por ejemplo:
     </para>
<screen>PARAM1=VAL1,PARAM2=VAL2,...</screen>
     <para>
      El ejemplo hace que el guion <command>rbdmap</command> ejecute el siguiente comando:
     </para>
<screen>rbd map <replaceable>pool_name</replaceable>/<replaceable>image_name</replaceable> --PARAM1 VAL1 --PARAM2 VAL2</screen>
    </listitem>
   </varlistentry>
  </variablelist>

  <para>
   Si se ejecuta como <command>rbdmap map</command>, el guion analiza el archivo de configuración y, para cada imagen RBD especificada, primero intenta asignar la imagen (mediante el comando <command>rbd map</command>) y luego montarla.
  </para>

  <para>
   Si se ejecuta como <command>rbdmap unmap</command>, las imágenes enumeradas en el archivo de configuración se desmontarán y se desasignarán.
  </para>

  <para>
   <command>rbdmap unmap-all</command> intenta desmontar y posteriormente desasignar todas las imágenes RBD asignadas actualmente, independientemente de que estén enumeradas o no en el archivo de configuración.
  </para>

  <para>
   Si la operación se realiza correctamente, rbd map asigna la imagen a un dispositivo /dev/rbdX, momento en el que se activa una regla udev para crear un enlace simbólico de nombre de dispositivo de confianza <filename>/dev/rbd/<replaceable>nombre_repositorio</replaceable>/<replaceable>nombre_imagen</replaceable></filename> que señala al dispositivo real asignado.
  </para>

  <para>
   Para que las operaciones de montaje y desmontaje se lleven a cabo correctamente, el nombre del dispositivo de confianza debe tener una entrada correspondiente en <filename>/etc/fstab</filename>. Al escribir entradas <filename>/etc/fstab</filename> para imágenes RBD, especifique la opción de montaje "noauto" (o "nofail"). Esto impide que el sistema Init intente montar el dispositivo demasiado pronto, antes de que el dispositivo en cuestión aún exista, ya que <filename>rbdmap.service</filename> normalmente se activa bastante tarde en la secuencia de arranque.
  </para>

  <para>
   Para una lista completa de opciones de <command>rbd</command>, consulte la página de manual de <command>rbd</command> (<command>man 8 rbd</command>).
  </para>

  <para>
   Para consultar ejemplos de uso de <command>rbdmap</command>, consulte la página de manual de <command>rbdmap</command> (<command>man 8 rbdmap</command>).
  </para>
 </sect1>
 <sect1 xml:id="ceph-rbd-mirror">
  <title>Duplicación de dispositivos de bloques RADOS</title>

  <para>
   Las imágenes RBD se pueden duplicar de forma asincrónica entre dos clústeres de Ceph. Esta función utiliza las imágenes RBD transaccionales para garantizar la replicación protegida contra bloqueos entre los clústeres. La duplicación se configura para cada repositorio con clústeres conectores y se puede configurar para que duplique automáticamente todas las imágenes de un repositorio o solo un subconjunto específico de imágenes. La duplicación se configura mediante el comando <command>rbd</command>. El daemon <systemitem>rbd-mirror</systemitem> es el responsable de la extracción de actualizaciones de imágenes en el clúster conector remoto y de aplicarlos a la imagen en el clúster local.
  </para>

  <important>
   <title>daemon rbd-mirror</title>
   <para>
    Para utilizar la duplicación RBD, debe disponer de dos clústeres Ceph con el daemon <systemitem>rbd-mirror</systemitem> en ejecución en ambos.
   </para>
  </important>

  <sect2 xml:id="rbd-mirror-daemon">
   <title>Daemon rbd-mirror</title>
   <para>
    Los dos daemons <systemitem>rbd-mirror</systemitem> son responsables de vigilar los diarios transaccionales de las imágenes en el clúster conector remoto y reproducir los eventos del diario en el clúster local. Las imágenes RBD transaccionales almacenan todas las modificaciones realizadas en la imagen en el orden en que se producen. Esto garantiza que exista localmente una duplicación de la imagen remota protegida contra errores.
   </para>
   <para>
    El daemon <systemitem>rbd-mirror</systemitem> está disponible en el paquete <systemitem>rbd-mirror</systemitem>. Instálelo, habilítelo e inícielo en uno de los nodos del clúster:
   </para>
<screen><prompt>root@minion &gt; </prompt>zypper install rbd-mirror
<prompt>root@minion &gt; </prompt>systemctl enable ceph-rbd-mirror@<replaceable>server_name</replaceable>.service
<prompt>root@minion &gt; </prompt>systemctl start ceph-rbd-mirror@<replaceable>server_name</replaceable>.service</screen>
   <important>
    <para>
     Cada daemon <systemitem>rbd-mirror</systemitem> requiere la capacidad de conectarse a ambos clústeres de forma simultánea.
    </para>
   </important>
  </sect2>

  <sect2 xml:id="ceph-rbd-mirror-poolconfig">
   <title>Configuración del repositorio</title>
   <para>
    Los siguientes procedimientos demuestran cómo llevar a cabo las tareas administrativas básicas para configurar la duplicación mediante el comando <command>rbd</command>. La duplicación se configura de forma independiente para cada repositorio dentro de los clústeres de Ceph.
   </para>
   <para>
    Debe llevar a cabo los pasos de configuración del repositorio en ambos clústeres conectores. Para simplificar los ejemplos, en estos procedimientos se presupone que hay dos clústeres, denominados "local" y "remote", accesibles desde un único host.
   </para>
   <para>
    Consulte la página de manual de <command>rbd</command> (<command>man 8 rbd</command>) para obtener información adicional acerca de cómo conectarse a clústeres de Ceph diferentes.
   </para>
   <tip>
    <title>varios clústeres</title>
    <para>
     En los siguientes ejemplos, el nombre del clúster se corresponde con un archivo de configuración de Ceph con el mismo nombre <filename>/etc/ceph/remote.conf</filename>. Consulte la documentación de <link xlink:href="http://docs.ceph.com/docs/master/rados/configuration/ceph-conf/#running-multiple-clusters">ceph-conf</link> para obtener información sobre cómo configurar varios clústeres.
    </para>
   </tip>
   <sect3>
    <title>Cómo habilitar la duplicación</title>
    <para>
     Para habilitar la duplicación en un repositorio, especifique el subcomando <command>mirror pool enable</command>, el nombre del repositorio y el modo de duplicación. El modo de duplicación puede ser de repositorio o de imagen:
    </para>
    <variablelist>
     <varlistentry>
      <term>pool</term>
      <listitem>
       <para>
        Se duplican todas las imágenes del repositorio con el registro transaccional habilitado.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>image</term>
      <listitem>
       <para>
        La duplicación se debe habilitar explícitamente en cada imagen. Consulte la <xref linkend="rbd-mirror-enable-image-mirroring"/> para obtener más información. 
       </para>
      </listitem>
     </varlistentry>
    </variablelist>
    <para>
     Por ejemplo:
    </para>
<screen><prompt>root # </prompt>rbd --cluster local mirror pool enable image-pool pool
<prompt>root # </prompt>rbd --cluster remote mirror pool enable image-pool pool</screen>
   </sect3>
   <sect3>
    <title>Cómo inhabilitar la duplicación</title>
    <para>
     Para inhabilitar la duplicación en un repositorio, especifique el subcomando <command>mirror pool disable</command> y el nombre del repositorio. Cuando se inhabilita la duplicación en un repositorio de esta forma, la duplicación también se inhabilitará en cualquier imagen (dentro del repositorio) para la que se haya habilitado la duplicación explícitamente.
    </para>
<screen><prompt>root # </prompt>rbd --cluster local mirror pool disable image-pool
<prompt>root # </prompt>rbd --cluster remote mirror pool disable image-pool</screen>
   </sect3>
   <sect3>
    <title>Adición de un clúster conector</title>
    <para>
     Para que el daemon <systemitem>rbd-mirror</systemitem> descubra su clúster conector, el conector debe estar registrado en el repositorio. Para añadir un clúster conector duplicado, especifique el subcomando <command>mirror pool peer add</command>, el nombre del repositorio y una especificación de clúster:
    </para>
<screen><prompt>root # </prompt>rbd --cluster local mirror pool peer add image-pool client.remote@remote
<prompt>root # </prompt>rbd --cluster remote mirror pool peer add image-pool client.local@local</screen>
   </sect3>
   <sect3>
    <title>Eliminación de un clúster conector</title>
    <para>
     Para eliminar un clúster conector duplicado, especifique el subcomando <command>mirror pool peer remove</command>, el nombre del repositorio y el UUID del conector (disponible mediante el comando <command>rbd mirror pool info</command>):
    </para>
<screen><prompt>root # </prompt>rbd --cluster local mirror pool peer remove image-pool \
 55672766-c02b-4729-8567-f13a66893445
<prompt>root # </prompt>rbd --cluster remote mirror pool peer remove image-pool \
 60c0e299-b38f-4234-91f6-eed0a367be08</screen>
   </sect3>
  </sect2>

  <sect2 xml:id="rbd-mirror-imageconfig">
   <title>Configuración de la imagen</title>
   <para>
    A diferencia de la configuración del repositorio, la configuración de la imagen solo se debe realizar en un único clúster conector duplicado de Ceph.
   </para>
   <para>
    Las imágenes RBD duplicadas se designan como <emphasis>primary</emphasis> (principal) o <emphasis>non-primary</emphasis> (no principal). Se trata de una propiedad de la imagen, no del repositorio. Las imágenes designadas como no principales no se pueden modificar.
   </para>
   <para>
    Las imágenes suben de nivel a principal automáticamente cuando la duplicación se habilita por primera vez en una imagen (ya sea implícita, si el modo de duplicación del repositorio es "pool" [repositorio] y la imagen cuenta con la función de imagen transaccional habilitada, o explícita [consulte la <xref linkend="rbd-mirror-enable-image-mirroring"/>], mediante el comando <command>rbd</command>).
   </para>
   <sect3>
    <title>Habilitación de la compatibilidad con imágenes transaccionales</title>
    <para>
     La duplicación RBD utiliza las imágenes RBD transaccionales para garantizar que la imagen replicada siempre esté protegida contra fallos. Para que una imagen se pueda duplicar en un clúster conector, es necesario habilitar la función de registro transaccional. La función se puede habilitar en el momento de creación de la imagen proporcionando la opción <option>--image-feature exclusive-lock,journaling</option> al comando <command>rbd</command>.
    </para>
    <para>
     Como alternativa, la función de registro transaccional se puede habilitar de forma dinámica en las imágenes RBD preexistentes. Para habilitar el registro transaccional, especifique el subcomando <command>feature enable</command>, el nombre del repositorio y la imagen y el nombre de la función:
    </para>
<screen><prompt>root # </prompt>rbd --cluster local feature enable image-pool/image-1 journaling</screen>
    <note>
     <title>dependencia de opciones</title>
     <para>
      La función <option>journaling</option> (registro transaccional) depende de la función <option>exclusive-lock</option> (bloqueo exclusivo). Si la función <option>exclusive-lock</option> no está habilitada, deberá habilitarla antes que la función <option>journaling</option>.
     </para>
    </note>
    <tip>
     <title>registro transaccional en todas las imágenes nuevas</title>
     <para>
      Para habilitar el registro transaccional por defecto para todas las imágenes nuevas, añada la siguiente línea al archivo de configuración de Ceph:
     </para>
<screen>rbd default features = 125</screen>
    </tip>
   </sect3>
   <sect3 xml:id="rbd-mirror-enable-image-mirroring">
    <title>Cómo habilitar la duplicación de imágenes</title>
    <para>
     Si la duplicación está configurada en el modo de imagen para el repositorio de la imagen, es necesario habilitar explícitamente la duplicación para cada imagen del repositorio. Para habilitar la duplicación de una imagen concreta, especifique el subcomando <command>mirror image enable</command> junto con el nombre del repositorio y el de la imagen:
    </para>
<screen><prompt>root # </prompt>rbd --cluster local mirror image enable image-pool/image-1</screen>
   </sect3>
   <sect3>
    <title>Cómo inhabilitar la duplicación de imágenes</title>
    <para>
     Para habilitar la duplicación de una imagen concreta, especifique el subcomando <command>mirror image disable</command> junto con el nombre del repositorio y el de la imagen:
    </para>
<screen><prompt>root # </prompt>rbd --cluster local mirror image disable image-pool/image-1</screen>
   </sect3>
   <sect3>
    <title>Cómo bajar o subir de nivel una imagen</title>
    <para>
     En una situación de failover en la que sea necesario mover la designación primara a la imagen del clúster conector, debe detener el acceso a la imagen principal, bajarla de nivel, subir el nivel de la nueva imagen principal y reanudar el acceso a la imagen en el clúster alternativo.
    </para>
    <para>
     Para bajar de nivel una imagen y convertirla en no principal, especifique el subcomando <command>mirror image demote</command> junto con el nombre del repositorio y el de la imagen:
    </para>
<screen><prompt>root # </prompt>rbd --cluster local mirror image demote image-pool/image-1</screen>
    <para>
     Para bajar de nivel todas las imágenes principales de un repositorio a no principales, especifique el subcomando <command>mirror pool demote</command> junto con el nombre del repositorio:
    </para>
<screen><prompt>root # </prompt>rbd --cluster local mirror pool demote image-pool</screen>
    <para>
     Para subir de nivel una imagen y convertirla en principal, especifique el subcomando <command>mirror image promote</command> junto con el nombre del repositorio y el de la imagen:
    </para>
<screen><prompt>root # </prompt>rbd --cluster remote mirror image promote image-pool/image-1</screen>
    <para>
     Para subir de nivel todas las imágenes de un repositorio a principales, especifique el subcomando <command>mirror pool promote</command> junto con el nombre del repositorio:
    </para>
<screen><prompt>root # </prompt>rbd --cluster local mirror pool promote image-pool</screen>
    <tip>
     <title>división de la carga de E/S</title>
     <para>
      Puesto que el estado principal o no principal se establece para cada imagen, es posible que haya dos clústeres que dividan la carga de E/S y el failover o failback por etapas.
     </para>
    </tip>
    <note>
     <title>subida de nivel forzosa</title>
     <para>
      Puede forzar la subida de nivel mediante la opción <option>--force</option>. Es necesario forzar la subida de nivel cuando la bajada de nivel no se puede propagar al clúster conector (por ejemplo, en caso de fallo del clúster o interrupción de la comunicación). Esto provocará una situación de división entre ambos conectores y la imagen dejará de sincronizarse hasta que se emita un subcomando <command>resync</command>.
     </para>
    </note>
   </sect3>
   <sect3>
    <title>Cómo forzar la resincronización de la imagen</title>
    <para>
     Si el daemon <systemitem>rbd-mirror</systemitem> detecta un evento dividido, no intentará duplicar la imagen afectada hasta que se corrija. Para reanudar la duplicación de una imagen, primero baje de nivel la imagen considerada obsoleta y, a continuación, realice una petición de resincronización de la imagen principal. Para pedir una resincronización de la imagen, especifique el subcomando <command>mirror image resync</command> junto con el nombre del repositorio y el de la imagen:
    </para>
<screen><prompt>root # </prompt>rbd mirror image resync image-pool/image-1</screen>
   </sect3>
  </sect2>

  <sect2 xml:id="rbd-mirror-status">
   <title>Estado de la duplicación</title>
   <para>
    El estado de replicación de clúster conector se almacena para cada imagen principal duplicada. Este estado se puede recuperar mediante los subcomandos <command>mirror image status</command> y <command>mirror pool status</command>:
   </para>
   <para>
    Para pedir el estado de la imagen duplicada, especifique el subcomando <command>mirror image status</command> junto con el nombre del repositorio y el de la imagen:
   </para>
<screen><prompt>root # </prompt>rbd mirror image status image-pool/image-1</screen>
   <para>
    Para pedir el estado resumido del repositorio de duplicación, especifique el subcomando <command>mirror pool status</command> junto con el nombre del repositorio:
   </para>
<screen><prompt>root # </prompt>rbd mirror pool status image-pool</screen>
   <tip>
    <title/>
    <para>
     Si se añade la opción <option>--verbose</option> al subcomando <command>mirror pool status</command>, también se mostrará la información de estado de todas las imágenes duplicadas del repositorio.
    </para>
   </tip>
  </sect2>
 </sect1>
</chapter>
