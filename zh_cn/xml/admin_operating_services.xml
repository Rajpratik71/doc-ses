<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="admin_operating_services.xml" version="5.0" xml:id="ceph-operating-services">
 <title>操作 Ceph 服务</title>
 <info>
      <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
        <dm:translation>yes</dm:translation>
        <dm:release>SES 5</dm:release>
      </dm:docmanager>
    </info>
    <para>
  您可以使用 <systemitem class="daemon">systemd</systemitem> 或通过 DeepSea 来操作 Ceph 服务。
 </para>
 <sect1 xml:id="operate-services-systemd">
  <title>使用 <systemitem class="daemon">systemd</systemitem> 操作 Ceph 服务</title>

  <para>
   使用 <command>systemctl</command> 命令操作所有与 Ceph 相关的服务。操作在您当前登录的节点上进行。您需要具备 <systemitem class="username">root</systemitem> 特权才能操作 Ceph 服务。
  </para>

  <sect2 xml:id="ceph-operating-services-targets">
   <title>使用目标启动、停止和重启动服务</title>
   <para>
    为了简化启动、停止和重启动节点上特定类型的所有服务（例如所有 Ceph 服务、所有 MON 或所有 OSD）的操作，Ceph 提供了以下 <systemitem class="daemon">systemd</systemitem> 单元文件：
   </para>
<screen><prompt>root # </prompt> ls /usr/lib/systemd/system/ceph*.target
ceph.target
ceph-osd.target
ceph-mon.target
ceph-mgr.target
ceph-mds.target
ceph-radosgw.target
ceph-rbd-mirror.target</screen>
   <para>
    要启动/停止/重启动节点上的所有 Ceph 服务，请运行以下命令：
   </para>
<screen><prompt>root # </prompt>systemctl stop ceph.target
<prompt>root # </prompt>systemctl start ceph.target
<prompt>root # </prompt>systemctl restart ceph.target</screen>
   <para>
    要启动/停止/重启动节点上的所有 OSD，请运行以下命令：
   </para>
<screen><prompt>root # </prompt>systemctl stop ceph-osd.target
<prompt>root # </prompt>systemctl start ceph-osd.target
<prompt>root # </prompt>systemctl restart ceph-osd.target</screen>
   <para>
    针对其他目标的命令与此类似。
   </para>
  </sect2>

  <sect2 xml:id="ceph-operating-services-individual">
   <title>启动、停止和重启动个别服务</title>
   <para>
    可以使用以下参数化 <systemitem class="daemon">systemd</systemitem> 单元文件操作个别服务：
   </para>
<screen>ceph-osd@.service
ceph-mon@.service
ceph-mds@.service
ceph-radosgw@.service
ceph-rbd-mirror@.service</screen>
   <para>
    要使用这些命令，首先需要确定要操作的服务的名称。请参见<xref linkend="ceph-operating-services-finding-names"/>了解有关如何识别服务的更多信息。
   </para>
   <para>
    要启动/停止/重启动 <literal>osd.1</literal> 服务，请运行以下命令：
   </para>
<screen><prompt>root # </prompt>systemctl stop ceph-osd@1.service
<prompt>root # </prompt>systemctl start ceph-osd@1.service
<prompt>root # </prompt>systemctl restart ceph-osd@1.service</screen>
   <para>
    针对其他服务类型的命令与此类似。
   </para>
  </sect2>

  <sect2 xml:id="ceph-operating-services-finding-names">
   <title>识别个别服务</title>
   <para>
    通过运行 <command>systemctl</command> 并使用 <command>grep</command> 命令过滤结果，可以确定特定类型服务的名称/编号。例如：
   </para>
<screen><prompt>root # </prompt>systemctl | grep -i 'ceph-osd.*service'
<prompt>root # </prompt>systemctl | grep -i 'ceph-mon.*service'
[...]</screen>
  </sect2>

  <sect2 xml:id="ceph-operating-services-status">
   <title>服务状态</title>
   <para>
    可以查询 <systemitem class="daemon">systemd</systemitem> 来了解服务的状态。例如：
   </para>
<screen><prompt>root # </prompt>systemctl status ceph-osd@1.service
<prompt>root # </prompt>systemctl status ceph-mon@<replaceable>HOSTNAME</replaceable>.service</screen>
   <para>
    请将 <replaceable>HOSTNAME</replaceable> 替换为运行守护进程的主机名。
   </para>
   <para>
    如果您不知道服务的确切名称/编号，请参见<xref linkend="ceph-operating-services-finding-names"/>。
   </para>
  </sect2>
 </sect1>
 <sect1 xml:id="Deepsea-restart">
  <title>使用 DeepSea 重启动 Ceph 服务</title>

  <para>
   将更新应用到集群节点之后，需要重启动所指定的服务，以使用最近安装的版本。
  </para>

  <note>
   <title>检查重启动</title>
   <para>
    重启动集群的过程可能需要一段时间。可通过运行以下命令来使用 Salt 事件总线检查事件：
   </para>
<screen><prompt>root@master # </prompt>salt-run state.event pretty=True</screen>
  </note>

  <sect2 xml:id="deepsea-restart-all">
   <title>重启动所有服务</title>
   <para>
    要重启动集群上的<emphasis>所有</emphasis>服务，请运行以下命令：
   </para>
<screen><prompt>root@master # </prompt>salt-run state.orch ceph.restart</screen>
   <para>
    各角色重启动的顺序不同，具体视 DeepSea 版本 (<command>rpm -q deepsea</command>) 而定：
   </para>
   <itemizedlist>
    <listitem>
     <para>
      如果 DeepSea 版本低于 0.8.4，则元数据服务器、iSCSI 网关、对象网关和 NFS Ganesha 服务将并行重启动。
     </para>
    </listitem>
    <listitem>
     <para>
      如果 DeepSea 为 0.8.4 或更高版本，您已配置的所有角色将按以下顺序重启动：Ceph Monitor、Ceph Manager、Ceph OSD、元数据服务器、对象网关、iSCSI 网关、NFS Ganesha。为了保持较短的停机时间并尽早发现潜在问题，请按顺序重启动各节点。例如，一次只重启动一个监视节点。
     </para>
    </listitem>
   </itemizedlist>
   <para>
    如果集群处于降级、不良的状态，该命令会等待集群恢复。
   </para>
  </sect2>

  <sect2 xml:id="deepsea-restart-specific">
   <title>重启动特定服务</title>
   <para>
    要重启动集群上的特定服务，请运行以下命令：
   </para>
<screen><prompt>root@master # </prompt>salt-run state.orch ceph.restart.<replaceable>service_name</replaceable></screen>
   <para>
    例如，要重启动所有对象网关，请运行以下命令：
   </para>
<screen><prompt>root@master # </prompt>salt-run state.orch ceph.restart.rgw</screen>
   <para>
    您可以使用以下目标：
   </para>
<screen><prompt>root@master # </prompt>salt-run state.orch ceph.restart.mon</screen>
<screen><prompt>root@master # </prompt>salt-run state.orch ceph.restart.mgr</screen>
<screen><prompt>root@master # </prompt>salt-run state.orch ceph.restart.osd</screen>
<screen><prompt>root@master # </prompt>salt-run state.orch ceph.restart.mds</screen>
<screen><prompt>root@master # </prompt>salt-run state.orch ceph.restart.rgw</screen>
<screen><prompt>root@master # </prompt>salt-run state.orch ceph.restart.igw</screen>
<screen><prompt>root@master # </prompt>salt-run state.orch ceph.restart.ganesha</screen>
  </sect2>
 </sect1>
</chapter>
